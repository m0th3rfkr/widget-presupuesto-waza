<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador Excel + MD desde Building Blocks</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .upload-section {
            border: 2px dashed #ddd;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .config-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .preview {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .preview pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Generador Excel + MD desde Building Blocks JSON</h1>
        <p>Genera autom√°ticamente un Excel estructurado y un documento Markdown desde tu JSON de building blocks</p>
        
        <!-- Secci√≥n de carga -->
        <div class="upload-section">
            <h3>Cargar JSON Building Blocks</h3>
            <div class="form-group">
                <label for="json-file-001">JSON Building Blocks v2.0:</label>
                <input type="file" id="json-file-001" accept=".json" />
            </div>
            <div class="form-group">
                <label for="template-file-002">Template Excel (opcional):</label>
                <input type="file" id="template-file-002" accept=".xlsx,.xls" />
            </div>
        </div>
        
        <!-- Configuraci√≥n del proyecto -->
        <div class="config-section">
            <div>
                <div class="form-group">
                    <label for="nombre-proyecto-003">Nombre del Proyecto:</label>
                    <input type="text" id="nombre-proyecto-003" value="Plataforma Ejemplo" />
                </div>
                
                <div class="form-group">
                    <label for="tarifa-base-004">Tarifa Base por Hora (MXN):</label>
                    <input type="number" id="tarifa-base-004" value="500" min="100" />
                </div>
                
                <div class="form-group">
                    <label for="tarifa-ia-005">Tarifa IA por Hora (MXN):</label>
                    <input type="number" id="tarifa-ia-005" value="300" min="50" />
                </div>
                
                <div class="form-group">
                    <label for="markup-006">Markup Cliente (%):</label>
                    <input type="number" id="markup-006" value="40" min="0" max="200" />
                </div>
                
                <div class="form-group">
                    <label for="eficiencia-ia-007">Eficiencia IA (% reducci√≥n):</label>
                    <input type="number" id="eficiencia-ia-007" value="35" min="0" max="80" />
                </div>
                
                <div class="form-group">
                    <label for="categorias-filtro-008">Categor√≠as a incluir (separadas por coma):</label>
                    <textarea id="categorias-filtro-008" placeholder="Dejar vac√≠o para incluir todas las categor√≠as..."></textarea>
                </div>
            </div>
            
            <div>
                <div class="form-group">
                    <label for="factor-pm-009">Factor PM (%):</label>
                    <input type="number" id="factor-pm-009" value="18" min="0" max="50" />
                </div>
                
                <div class="form-group">
                    <label for="factor-testing-010">Factor Testing (%):</label>
                    <input type="number" id="factor-testing-010" value="12" min="0" max="30" />
                </div>
                
                <div class="form-group">
                    <label for="factor-contingencia-011">Factor Contingencia (%):</label>
                    <input type="number" id="factor-contingencia-011" value="20" min="0" max="50" />
                </div>
            </div>
        </div>
        
        <div style="text-align: center;">
            <button onclick="generarArchivos()">üìä Generar Excel + MD</button>
            <button onclick="generarArchivosConN8N()">ü§ñ Generar con AI (n8n)</button>
            <button onclick="generarGoogleSheets()">üìã Generar Google Sheets</button>
            <button onclick="previsualizarMD()">üëÅÔ∏è Preview MD</button>
        </div>
        
        <!-- Preview del Markdown -->
        <div id="preview-container-012" class="preview" style="display: none;">
            <h4>Preview del Markdown:</h4>
            <pre id="preview-content-013"></pre>
        </div>
    </div>

    <script>
        let buildingBlocksData = null;
        let templateData = null;
        
        // Event listeners para cargar archivos
        document.getElementById('json-file-001').addEventListener('change', (e) => {
            if (e.target.files[0]) {
                cargarJSON(e.target.files[0]);
            }
        });
        
        document.getElementById('template-file-002').addEventListener('change', (e) => {
            if (e.target.files[0]) {
                cargarTemplate(e.target.files[0]);
            }
        });
        
        function cargarJSON(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.categories || !data.metadata) {
                        throw new Error('El JSON no tiene la estructura esperada');
                    }
                    buildingBlocksData = data;
                    mostrarMensaje('JSON cargado correctamente', 'success');
                } catch (error) {
                    mostrarMensaje('Error al cargar JSON: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }
        
        function cargarTemplate(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'array' });
                    templateData = workbook;
                    mostrarMensaje('Template Excel cargado correctamente', 'success');
                } catch (error) {
                    mostrarMensaje('Error al cargar template: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function generarArchivos() {
            if (!buildingBlocksData) {
                mostrarMensaje('Primero carga el archivo JSON', 'error');
                return;
            }
            
            try {
                const config = obtenerConfiguracion();
                const datosEstructurados = procesarBuildingBlocks(buildingBlocksData, config);
                
                // Generar Excel nuevo (completo)
                generarExcel(datosEstructurados, config);
                
                // Llenar template si existe
                if (templateData) {
                    llenarTemplate(datosEstructurados, config);
                }
                
                // Generar Markdown
                generarMarkdown(datosEstructurados, config);
                
                mostrarMensaje('Archivos generados correctamente', 'success');
            } catch (error) {
                mostrarMensaje('Error al generar archivos: ' + error.message, 'error');
            }
        }
        
        function obtenerConfiguracion() {
            const categoriasFiltroText = document.getElementById('categorias-filtro-008').value.trim();
            const categoriasFiltro = categoriasFiltroText ? 
                categoriasFiltroText.split(',').map(c => c.trim()) : null;
            
            return {
                nombreProyecto: document.getElementById('nombre-proyecto-003').value,
                tarifaBase: parseFloat(document.getElementById('tarifa-base-004').value),
                tarifaIA: parseFloat(document.getElementById('tarifa-ia-005').value),
                markup: parseFloat(document.getElementById('markup-006').value),
                eficienciaIA: parseFloat(document.getElementById('eficiencia-ia-007').value),
                categoriasFiltro: categoriasFiltro,
                factorPM: parseFloat(document.getElementById('factor-pm-009').value),
                factorTesting: parseFloat(document.getElementById('factor-testing-010').value),
                factorContingencia: parseFloat(document.getElementById('factor-contingencia-011').value)
            };
        }
        
        function procesarBuildingBlocks(data, config) {
            const componentes = [];
            const categorias = {};
            let idCounter = 1;
            
            for (const [categoriaId, categoria] of Object.entries(data.categories)) {
                // Filtrar categor√≠as si se especific√≥
                if (config.categoriasFiltro && 
                    !config.categoriasFiltro.some(filtro => 
                        categoria.name.toLowerCase().includes(filtro.toLowerCase()) ||
                        categoriaId.toLowerCase().includes(filtro.toLowerCase())
                    )) {
                    continue;
                }
                
                if (!categorias[categoria.name]) {
                    categorias[categoria.name] = {
                        horas: { facil: 0, intermedio: 0, complejo: 0 },
                        horasIA: { facil: 0, intermedio: 0, complejo: 0 },
                        costosHumanos: { facil: 0, intermedio: 0, complejo: 0 },
                        costosIA: { facil: 0, intermedio: 0, complejo: 0 },
                        costosCliente: { facil: 0, intermedio: 0, complejo: 0 },
                        items: 0
                    };
                }
                
                for (const [blockId, block] of Object.entries(categoria.building_blocks)) {
                    const horasFacil = block.hours.facil;
                    const horasIntermedio = block.hours.intermedio;
                    const horasComplejo = block.hours.complejo;
                    
                    // Calcular horas con eficiencia IA
                    const factorEficiencia = (100 - config.eficienciaIA) / 100;
                    const horasIAFacil = Math.round(horasFacil * factorEficiencia);
                    const horasIAIntermedio = Math.round(horasIntermedio * factorEficiencia);
                    const horasIAComplejo = Math.round(horasComplejo * factorEficiencia);
                    
                    // Costos humanos
                    const costoHumanoFacil = horasFacil * config.tarifaBase;
                    const costoHumanoIntermedio = horasIntermedio * config.tarifaBase;
                    const costoHumanoComplejo = horasComplejo * config.tarifaBase;
                    
                    // Costos con IA
                    const costoIAFacil = horasIAFacil * config.tarifaIA;
                    const costoIAIntermedio = horasIAIntermedio * config.tarifaIA;
                    const costoIAComplejo = horasIAComplejo * config.tarifaIA;
                    
                    // Costos para cliente (con markup)
                    const factorMarkup = (100 + config.markup) / 100;
                    const costoClienteFacil = costoIAFacil * factorMarkup;
                    const costoClienteIntermedio = costoIAIntermedio * factorMarkup;
                    const costoClienteComplejo = costoIAComplejo * factorMarkup;
                    
                    componentes.push({
                        id: idCounter++,
                        categoria: categoria.name,
                        componente: block.name,
                        buildingBlocks: blockId,
                        // Horas originales
                        horasFacil: horasFacil,
                        horasIntermedio: horasIntermedio,
                        horasComplejo: horasComplejo,
                        // Horas con IA
                        horasIAFacil: horasIAFacil,
                        horasIAIntermedio: horasIAIntermedio,
                        horasIAComplejo: horasIAComplejo,
                        // Costos humanos
                        costoHumanoFacil: costoHumanoFacil,
                        costoHumanoIntermedio: costoHumanoIntermedio,
                        costoHumanoComplejo: costoHumanoComplejo,
                        // Costos IA
                        costoIAFacil: costoIAFacil,
                        costoIAIntermedio: costoIAIntermedio,
                        costoIAComplejo: costoIAComplejo,
                        // Costos cliente
                        costoClienteFacil: costoClienteFacil,
                        costoClienteIntermedio: costoClienteIntermedio,
                        costoClienteComplejo: costoClienteComplejo,
                        functionPoints: block.function_points || { facil: 0, intermedio: 0, complejo: 0 }
                    });
                    
                    // Agregar a totales por categor√≠a
                    categorias[categoria.name].horas.facil += horasFacil;
                    categorias[categoria.name].horas.intermedio += horasIntermedio;
                    categorias[categoria.name].horas.complejo += horasComplejo;
                    categorias[categoria.name].horasIA.facil += horasIAFacil;
                    categorias[categoria.name].horasIA.intermedio += horasIAIntermedio;
                    categorias[categoria.name].horasIA.complejo += horasIAComplejo;
                    categorias[categoria.name].costosHumanos.facil += costoHumanoFacil;
                    categorias[categoria.name].costosHumanos.intermedio += costoHumanoIntermedio;
                    categorias[categoria.name].costosHumanos.complejo += costoHumanoComplejo;
                    categorias[categoria.name].costosIA.facil += costoIAFacil;
                    categorias[categoria.name].costosIA.intermedio += costoIAIntermedio;
                    categorias[categoria.name].costosIA.complejo += costoIAComplejo;
                    categorias[categoria.name].costosCliente.facil += costoClienteFacil;
                    categorias[categoria.name].costosCliente.intermedio += costoClienteIntermedio;
                    categorias[categoria.name].costosCliente.complejo += costoClienteComplejo;
                    categorias[categoria.name].items += 1;
                }
            }
            
            return { componentes, categorias };
        }
        
        function crearContenidoMarkdown(datos, config) {
            let markdown = `# Estructura Excel - Cotizaci√≥n ${config.nombreProyecto}\n\n`;
            markdown += `*Generado con IA - Eficiencia ${config.eficienciaIA}% - Markup ${config.markup}%*\n\n`;
            
            // Hoja 1: Cotizaci√≥n Principal
            markdown += `## Hoja 1: "Cotizaci√≥n_Principal"\n\n`;
            markdown += `| ID | Categor√≠a | Componente | Building Blocks | Horas_IA_B√°sico | Horas_IA_Est√°ndar | Horas_IA_Enterprise | Costo_Cliente_B√°sico | Costo_Cliente_Est√°ndar | Costo_Cliente_Enterprise |\n`;
            markdown += `|----|-----------|------------|-----------------|-----------------|-------------------|---------------------|---------------------|----------------------|------------------------|\n`;
            
            datos.componentes.forEach(comp => {
                markdown += `| ${comp.id} | ${comp.categoria} | ${comp.componente} | ${comp.buildingBlocks} | ${comp.horasIAFacil} | ${comp.horasIAIntermedio} | ${comp.horasIAComplejo} | ${Math.round(comp.costoClienteFacil)} | ${Math.round(comp.costoClienteIntermedio)} | ${Math.round(comp.costoClienteComplejo)} |\n`;
            });
            
            // Hoja 2: Comparativa de Eficiencia
            markdown += `\n## Hoja 2: "Comparativa_Costos"\n\n`;
            markdown += `| Categor√≠a | Nivel | Horas_Humanos | Horas_IA | Costo_Humanos | Costo_IA | Costo_Cliente | Ahorro_Horas | Ahorro_% |\n`;
            markdown += `|-----------|-------|---------------|----------|---------------|----------|---------------|--------------|----------|\n`;
            
            for (const [nombreCat, datosCategoria] of Object.entries(datos.categorias)) {
                ['B√°sico', 'Est√°ndar', 'Enterprise'].forEach((nivel, idx) => {
                    const nivelKey = ['facil', 'intermedio', 'complejo'][idx];
                    const horasHumanos = datosCategoria.horas[nivelKey];
                    const horasIA = datosCategoria.horasIA[nivelKey];
                    const costoHumanos = datosCategoria.costosHumanos[nivelKey];
                    const costoIA = datosCategoria.costosIA[nivelKey];
                    const costoCliente = datosCategoria.costosCliente[nivelKey];
                    const ahorroHoras = horasHumanos - horasIA;
                    const ahorroPorcentaje = horasHumanos > 0 ? ((ahorroHoras / horasHumanos) * 100).toFixed(1) : 0;
                    
                    markdown += `| ${nombreCat} | ${nivel} | ${horasHumanos} | ${horasIA} | ${Math.round(costoHumanos)} | ${Math.round(costoIA)} | ${Math.round(costoCliente)} | ${ahorroHoras} | ${ahorroPorcentaje}% |\n`;
                });
            }
            
            // Hoja 3: Totales por Categor√≠a
            markdown += `\n## Hoja 3: "Totales_por_Categoria"\n\n`;
            markdown += `| Categor√≠a | Items | Horas_IA_B√°sico | Horas_IA_Est√°ndar | Horas_IA_Enterprise | Costo_Cliente_B√°sico | Costo_Cliente_Est√°ndar | Costo_Cliente_Enterprise |\n`;
            markdown += `|-----------|-------|-----------------|-------------------|---------------------|---------------------|----------------------|------------------------|\n`;
            
            let totalHorasIA = { facil: 0, intermedio: 0, complejo: 0 };
            let totalCostosCliente = { facil: 0, intermedio: 0, complejo: 0 };
            
            for (const [nombreCat, datosCategoria] of Object.entries(datos.categorias)) {
                markdown += `| ${nombreCat} | ${datosCategoria.items} | ${datosCategoria.horasIA.facil} | ${datosCategoria.horasIA.intermedio} | ${datosCategoria.horasIA.complejo} | ${Math.round(datosCategoria.costosCliente.facil)} | ${Math.round(datosCategoria.costosCliente.intermedio)} | ${Math.round(datosCategoria.costosCliente.complejo)} |\n`;
                
                totalHorasIA.facil += datosCategoria.horasIA.facil;
                totalHorasIA.intermedio += datosCategoria.horasIA.intermedio;
                totalHorasIA.complejo += datosCategoria.horasIA.complejo;
                totalCostosCliente.facil += datosCategoria.costosCliente.facil;
                totalCostosCliente.intermedio += datosCategoria.costosCliente.intermedio;
                totalCostosCliente.complejo += datosCategoria.costosCliente.complejo;
            }
            
            markdown += `| **TOTAL GENERAL** | **${datos.componentes.length}** | **${totalHorasIA.facil}** | **${totalHorasIA.intermedio}** | **${totalHorasIA.complejo}** | **${Math.round(totalCostosCliente.facil)}** | **${Math.round(totalCostosCliente.intermedio)}** | **${Math.round(totalCostosCliente.complejo)}** |\n`;
            
            // Continuar con el resto del markdown...
            return markdown;
        }
        
        function generarExcel(datos, config) {
            const wb = XLSX.utils.book_new();
            
            // Funci√≥n para categorizar building blocks
            function categorizarComponentes(componentes) {
                const categorias = {
                    arquitectura: [],
                    funcionales: [],
                    noFuncionales: []
                };
                
                componentes.forEach(comp => {
                    // Mapeo basado en categor√≠as existentes
                    if (comp.categoria === 'frontend' || comp.categoria === 'backend' || comp.categoria === 'devops') {
                        categorias.arquitectura.push(comp);
                    } else if (comp.categoria === 'ui' || comp.categoria === 'features' || comp.buildingBlocks.includes('user') || comp.buildingBlocks.includes('interface')) {
                        categorias.funcionales.push(comp);
                    } else {
                        categorias.noFuncionales.push(comp);
                    }
                });
                
                return categorias;
            }
            
            const categoriasData = categorizarComponentes(datos.componentes);
            const cotizacionData = [];
            
            // Header del documento con formato exacto del template
            cotizacionData.push(['WAZA', '', '', '', '', '', '', '', '', '', '', '', '', 'COTIZACI√ìN', 'MEXICO']);
            cotizacionData.push(['', '', '', '', '', '', '', '', '', '', '', '', '', '3 DE SEPTIEMBRE 2025']);
            cotizacionData.push(['CLIENTE:', '', '', '', '', '', '', '', '', '', 'MXN']);
            cotizacionData.push(['PROYECTO:', config.nombreProyecto || 'PLATAFORMA DE STREAMING']);
            cotizacionData.push(['EJECUTIVO:', '', '', '', '', '', '', '', '', '', 'JOS√â ANTONIO MANGARA']);
            cotizacionData.push(['']); // L√≠nea vac√≠a
            
            // Funci√≥n para agregar una secci√≥n
            function agregarSeccion(nombre, componentes, color) {
                // Header de la secci√≥n con formato exacto
                cotizacionData.push([nombre, '', '', '', '', '', '', '', '', '', '', '', '', '', 'PRECIO']);
                cotizacionData.push(['ITEM', 'DESCRIPCI√ìN', 'CANTIDAD', 'COSTO', 'TOKENS', 'HRS', 'COSTO FINAL', 'CANTIDAD', 'COSTO', 'HRS', 'SOFTWARES', 'COSTO FINAL', 'MARKUP', 'SUBTOTAL']);
                
                let subtotal = 0;
                componentes.forEach((comp, index) => {
                    const costoFinal = Math.round(comp.costoClienteIntermedio);
                    subtotal += costoFinal;
                    
                    cotizacionData.push([
                        comp.componente,
                        comp.buildingBlocks,
                        1, // Cantidad
                        Math.round(comp.costoClienteIntermedio * 0.6), // Costo base
                        Math.round(comp.horasIAIntermedio * 100), // Tokens simulados
                        comp.horasIAIntermedio,
                        Math.round(comp.costoClienteIntermedio * 0.6),
                        1, // Cantidad humanos
                        Math.round(comp.costoClienteIntermedio * 0.4), // Costo humanos
                        Math.round(comp.horasIAIntermedio * 2), // Horas humanas (doble que IA)
                        'Herramientas Dev',
                        Math.round(comp.costoClienteIntermedio * 0.4),
                        config.markupCliente + '%',
                        costoFinal
                    ]);
                });
                
                // Subtotal de la secci√≥n
                cotizacionData.push(['SUBTOTAL', '', '', '', '', '', '', '', '', '', '', '', '', subtotal]);
                cotizacionData.push(['']); // L√≠nea vac√≠a
                
                return subtotal;
            }
            
            // Agregar las tres secciones
            let totalGeneral = 0;
            totalGeneral += agregarSeccion('Arquitectura T√©cnica', categoriasData.arquitectura, 'blue');
            totalGeneral += agregarSeccion('Requisitos Funcionales', categoriasData.funcionales, 'blue');
            totalGeneral += agregarSeccion('Requisitos No Funcionales', categoriasData.noFuncionales, 'blue');
            
            // Total general
            cotizacionData.push(['GRAN TOTAL', '', '', '', '', '', '', '', '', '', '', '', '', totalGeneral]);
            cotizacionData.push(['']); // L√≠nea vac√≠a
            cotizacionData.push(['NOTAS:']);
            cotizacionData.push(['']);
            cotizacionData.push(['Alcance & cambios: Es una estimaci√≥n, si cambian requerimientos/t√©cnicas, cambian costo y tiempo; se tomar√°n los datos vigentes']);
            cotizacionData.push(['Moneda $ MXN. Impuestos no incluidos (IVA, s√≠ hay cargos del IVA), si hay cargo en USD (nacional), se podr√°n al tipo de cambio vigente.']);
            cotizacionData.push(['']);
            cotizacionData.push(['Responsabilidades del cliente: Entregar informaci√≥n, accesos, aprobaciones, API keys, dominio/DNS y permisos a tiempo.']);
            cotizacionData.push(['Roles & migracion: Incluye migracion basica desde DirectAdmin /Plesk/WhmlX+cintentrix especiales de codigos vivos']);
            cotizacionData.push(['cargos no incluyen instalaciones, ajustes de forma, propuestas de cambio y entitar otros']);
            cotizacionData.push(['Sugeridos: cron entregar plan estrategico, legalVox de informacion externa de datos, propuestas de segway y verificar tiempos']);
            
            const wsCotizacion = XLSX.utils.aoa_to_sheet(cotizacionData);
            XLSX.utils.book_append_sheet(wb, wsCotizacion, "Cotizaci√≥n_WAZA");
            
            // Tab 2: Estructura detallada original
            const detalladaData = [
                ['ID', 'Categor√≠a', 'Componente', 'Building Blocks', 
                 'Horas_IA_B√°sico', 'Horas_IA_Est√°ndar', 'Horas_IA_Enterprise', 
                 'Costo_Cliente_B√°sico', 'Costo_Cliente_Est√°ndar', 'Costo_Cliente_Enterprise']
            ];
            
            datos.componentes.forEach(comp => {
                detalladaData.push([
                    comp.id,
                    comp.categoria,
                    comp.componente,
                    comp.buildingBlocks,
                    comp.horasIAFacil,
                    comp.horasIAIntermedio,
                    comp.horasIAComplejo,
                    Math.round(comp.costoClienteFacil),
                    Math.round(comp.costoClienteIntermedio),
                    Math.round(comp.costoClienteComplejo)
                ]);
            });
            
            const wsDetallada = XLSX.utils.aoa_to_sheet(detalladaData);
            XLSX.utils.book_append_sheet(wb, wsDetallada, "Cotizaci√≥n_Detallada");
            
            // Descargar Excel
            const fecha = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `cotizacion_${config.nombreProyecto.replace(/\s+/g, '_')}_${fecha}.xlsx`);
        }
        
        function generarMarkdown(datos, config) {
            const markdown = crearContenidoMarkdown(datos, config);
            
            // Crear y descargar archivo MD
            const blob = new Blob([markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fecha = new Date().toISOString().slice(0, 10);
            a.download = `cotizacion_${config.nombreProyecto.replace(/\s+/g, '_')}_${fecha}.md`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function llenarTemplate(datos, config) {
            // Template filling logic would go here
            mostrarMensaje('Funcionalidad de template pendiente de implementaci√≥n', 'error');
        }
        
        function previsualizarMD() {
            if (!buildingBlocksData) {
                mostrarMensaje('Primero carga el archivo JSON', 'error');
                return;
            }
            
            try {
                const config = obtenerConfiguracion();
                const datosEstructurados = procesarBuildingBlocks(buildingBlocksData, config);
                const markdown = crearContenidoMarkdown(datosEstructurados, config);
                
                document.getElementById('preview-content-013').textContent = markdown;
                document.getElementById('preview-container-012').style.display = 'block';
                
                mostrarMensaje('Preview generado', 'success');
            } catch (error) {
                mostrarMensaje('Error al generar preview: ' + error.message, 'error');
            }
        }
        
        // n8n Integration Function
        async function generarArchivosConN8N() {
            if (!buildingBlocksData) {
                mostrarMensaje('Primero carga el archivo JSON', 'error');
                return;
            }
            
            try {
                mostrarMensaje('Enviando datos para procesamiento con AI...', 'info');
                
                const config = obtenerConfiguracion();
                const payload = {
                    building_blocks: buildingBlocksData,
                    config: config
                };
                
                // Budget processor API URL
                const budgetApiUrl = 'http://localhost:3001/budget-quote';
                
                const response = await fetch(budgetApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    mostrarMensaje('‚úÖ Cotizaci√≥n generada exitosamente con AI!', 'success');
                    
                    // Display the results
                    displayN8NResults(result.data);
                    
                    // Download files if available
                    if (result.data.markdown) {
                        downloadFile(result.data.markdown, result.data.filename + '.md', 'text/markdown');
                    }
                    if (result.data.csv) {
                        downloadFile(result.data.csv, result.data.filename + '.csv', 'text/csv');
                    }
                } else {
                    throw new Error(result.message || 'Error procesando datos');
                }
                
            } catch (error) {
                console.error('Error procesando:', error);
                mostrarMensaje('Error procesando: ' + error.message, 'error');
            }
        }
        
        function displayN8NResults(data) {
            // Create results display area
            let resultsDiv = document.getElementById('n8n-results-014');
            if (!resultsDiv) {
                resultsDiv = document.createElement('div');
                resultsDiv.id = 'n8n-results-014';
                resultsDiv.className = 'preview';
                resultsDiv.style.display = 'block';
                document.querySelector('.container').appendChild(resultsDiv);
            }
            
            const processed = data.processed;
            let html = `
                <h3>ü§ñ Resultados Procesados con AI</h3>
                <h4>Proyecto: ${processed.project_name}</h4>
                <p><strong>Generado:</strong> ${new Date(processed.generated_at).toLocaleString()}</p>
                
                <h4>üí∞ Costos Totales</h4>
                <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                    <tr style="background: #f0f0f0;">
                        <th style="border: 1px solid #ddd; padding: 8px;">Nivel</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Costo Total</th>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">B√°sico</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">$${Math.round(processed.totals.basic).toLocaleString()} MXN</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">Est√°ndar</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">$${Math.round(processed.totals.standard).toLocaleString()} MXN</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">Enterprise</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">$${Math.round(processed.totals.enterprise).toLocaleString()} MXN</td>
                    </tr>
                </table>
                
                <h4>üìã Categor√≠as</h4>
            `;
            
            for (const [name, category] of Object.entries(processed.categories)) {
                html += `
                    <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <h5>${name}</h5>
                        <p><strong>Items:</strong> ${category.items}</p>
                        <p><strong>Horas:</strong> ${category.hours.basic.toFixed(1)} / ${category.hours.standard.toFixed(1)} / ${category.hours.enterprise.toFixed(1)}</p>
                        <p><strong>Costos:</strong> $${Math.round(category.costs.basic).toLocaleString()} / $${Math.round(category.costs.standard).toLocaleString()} / $${Math.round(category.costs.enterprise).toLocaleString()} MXN</p>
                    </div>
                `;
            }
            
            html += `
                <h4>‚öôÔ∏è Configuraci√≥n Aplicada</h4>
                <ul>
                    <li><strong>Eficiencia IA:</strong> ${processed.config.eficienciaIA || 35}%</li>
                    <li><strong>Markup:</strong> ${processed.config.markup || 40}%</li>
                    <li><strong>Tarifa IA:</strong> $${processed.config.tarifaIA || 300} MXN/hora</li>
                    <li><strong>Factor PM:</strong> ${processed.config.factorPM || 18}%</li>
                    <li><strong>Factor Testing:</strong> ${processed.config.factorTesting || 12}%</li>
                    <li><strong>Factor Contingencia:</strong> ${processed.config.factorContingencia || 20}%</li>
                </ul>
            `;
            
            resultsDiv.innerHTML = html;
        }
        
        // Google Sheets API configuration
        const GOOGLE_CONFIG = {
            apiKey: 'AIzaSyA5WkzYdrn2v24fgB1rln5qnbhs7iivFNs',
            clientId: '64644619494-tous9hjfmhdpmcfnj18b067tnj3ve9f9.apps.googleusercontent.com',
            discoveryDocs: [
                'https://sheets.googleapis.com/$discovery/rest?version=v4',
                'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'
            ],
            scopes: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file'
        };

        let isGoogleAPIReady = false;

        // Inicializar Google API
        function initializeGoogleAPI() {
            return new Promise((resolve, reject) => {
                gapi.load('client:auth2', async () => {
                    try {
                        await gapi.client.init({
                            apiKey: GOOGLE_CONFIG.apiKey,
                            clientId: GOOGLE_CONFIG.clientId,
                            discoveryDocs: GOOGLE_CONFIG.discoveryDocs,
                            scope: GOOGLE_CONFIG.scopes
                        });
                        isGoogleAPIReady = true;
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                });
            });
        }

        // Funci√≥n simplificada sin autenticaci√≥n autom√°tica
        function generarGoogleSheets() {
            if (!buildingBlocksData) {
                mostrarMensaje('Primero carga el archivo JSON', 'error');
                return;
            }

            try {
                const config = obtenerConfiguracion();
                const datos = procesarBuildingBlocks(buildingBlocksData, config);

                // Abrir template directamente para copia manual
                const templateUrl = 'https://docs.google.com/spreadsheets/d/1oKLjM3GdariaTP4uuFjYDgCKXcMk-7xeuLta0okX-oI/copy';
                window.open(templateUrl, '_blank');

                // Mostrar instrucciones con datos para copiar
                mostrarInstruccionesGoogleSheets(datos, config);

                mostrarMensaje('‚úÖ Template abierto. Sigue las instrucciones para copiar los datos.', 'success');

            } catch (error) {
                console.error('Error:', error);
                mostrarMensaje('‚ùå Error: ' + error.message, 'error');
            }
        }

        // Autenticar con Google
        async function authenticateGoogle() {
            return new Promise((resolve, reject) => {
                console.log('Cargando gapi client...');
                console.log('Dominio actual:', window.location.origin);
                
                gapi.load('client:auth2', {
                    callback: async () => {
                        try {
                            console.log('GAPI cargado, inicializando...');
                            console.log('Config:', GOOGLE_CONFIG);
                            
                            const initConfig = {
                                apiKey: GOOGLE_CONFIG.apiKey,
                                clientId: GOOGLE_CONFIG.clientId,
                                discoveryDocs: GOOGLE_CONFIG.discoveryDocs,
                                scope: GOOGLE_CONFIG.scopes
                            };
                            
                            console.log('Configuraci√≥n de inicializaci√≥n:', initConfig);
                            
                            const initResult = await gapi.client.init(initConfig);
                            console.log('Resultado de inicializaci√≥n:', initResult);
                            
                            console.log('Google API inicializada exitosamente');
                            const authInstance = gapi.auth2.getAuthInstance();
                            console.log('Auth instance obtenida:', authInstance);
                            
                            const isSignedIn = authInstance.isSignedIn.get();
                            console.log('¬øUsuario ya autenticado?', isSignedIn);
                            
                            if (!isSignedIn) {
                                console.log('Solicitando login...');
                                try {
                                    console.log('Llamando a signIn()...');
                                    const user = await authInstance.signIn({
                                        prompt: 'select_account'
                                    });
                                    console.log('Login exitoso:', user.getBasicProfile().getName());
                                } catch (loginError) {
                                    console.error('Error en login:', loginError);
                                    if (loginError.error === 'popup_blocked_by_browser') {
                                        reject(new Error('Popup bloqueado por el navegador. Permite popups para este sitio.'));
                                    } else if (loginError.error === 'access_denied') {
                                        reject(new Error('Acceso denegado por el usuario.'));
                                    } else {
                                        reject(loginError);
                                    }
                                    return;
                                }
                            }
                            
                            console.log('Autenticaci√≥n completada exitosamente');
                            resolve();
                            
                        } catch (error) {
                            console.error('Error en inicializaci√≥n:', error);
                            console.error('Detalles del error:', error.details);
                            
                            if (error.error === 'idpiframe_initialization_failed') {
                                reject(new Error('Error de inicializaci√≥n. Verifica que el dominio est√© autorizado en Google Cloud Console.'));
                            } else {
                                reject(error);
                            }
                        }
                    },
                    onerror: (error) => {
                        console.error('Error cargando GAPI:', error);
                        reject(new Error('Error cargando Google API'));
                    }
                });
            });
        }

        // Crear copia del template
        async function copyGoogleSheet(templateId, newName) {
            try {
                console.log('Copiando template:', templateId, 'con nombre:', newName);
                
                const response = await gapi.client.request({
                    path: `https://www.googleapis.com/drive/v3/files/${templateId}/copy`,
                    method: 'POST',
                    body: {
                        name: newName
                    }
                });
                
                console.log('Respuesta de copia:', response);
                
                if (response.result && response.result.id) {
                    console.log('Copia creada exitosamente con ID:', response.result.id);
                    return response.result.id;
                } else {
                    throw new Error('No se pudo obtener ID del archivo copiado');
                }
                
            } catch (error) {
                console.error('Error creando copia:', error);
                throw error;
            }
        }

        // Llenar datos en Google Sheet autom√°ticamente
        async function populateGoogleSheet(sheetId, datos, config) {
            const values = [];
            
            // Categorizar componentes
            const arquitectura = datos.componentes.filter(c => c.categoria === 'frontend' || c.categoria === 'backend' || c.categoria === 'devops');
            const funcionales = datos.componentes.filter(c => !['frontend', 'backend', 'devops'].includes(c.categoria));
            
            // Llenar secci√≥n Arquitectura T√©cnica (empezar en fila 8)
            let currentRow = 8;
            arquitectura.forEach(comp => {
                values.push({
                    range: `A${currentRow}:N${currentRow}`,
                    values: [[
                        comp.componente,
                        comp.buildingBlocks,
                        1,
                        Math.round(comp.costoClienteIntermedio * 0.6),
                        Math.round(comp.horasIAIntermedio * 100),
                        comp.horasIAIntermedio,
                        Math.round(comp.costoClienteIntermedio * 0.6),
                        1,
                        Math.round(comp.costoClienteIntermedio * 0.4),
                        Math.round(comp.horasIAIntermedio * 2),
                        'Herramientas Dev',
                        Math.round(comp.costoClienteIntermedio * 0.4),
                        config.markupCliente + '%',
                        Math.round(comp.costoClienteIntermedio)
                    ]]
                });
                currentRow++;
            });
            
            // Saltar a secci√≥n Requisitos Funcionales (aproximadamente fila 20)
            currentRow = 20;
            funcionales.forEach(comp => {
                values.push({
                    range: `A${currentRow}:N${currentRow}`,
                    values: [[
                        comp.componente,
                        comp.buildingBlocks,
                        1,
                        Math.round(comp.costoClienteIntermedio * 0.6),
                        Math.round(comp.horasIAIntermedio * 100),
                        comp.horasIAIntermedio,
                        Math.round(comp.costoClienteIntermedio * 0.6),
                        1,
                        Math.round(comp.costoClienteIntermedio * 0.4),
                        Math.round(comp.horasIAIntermedio * 2),
                        'Herramientas Dev',
                        Math.round(comp.costoClienteIntermedio * 0.4),
                        config.markupCliente + '%',
                        Math.round(comp.costoClienteIntermedio)
                    ]]
                });
                currentRow++;
            });

            // Actualizar datos del proyecto
            values.push({
                range: 'B4:B4',
                values: [[config.nombreProyecto]]
            });

            // Enviar todos los datos de una vez
            const batchUpdateRequest = {
                valueInputOption: 'RAW',
                data: values
            };

            await gapi.client.sheets.spreadsheets.values.batchUpdate({
                spreadsheetId: sheetId,
                resource: batchUpdateRequest
            });
        }

        // Mostrar instrucciones y datos para copiar/pegar
        function mostrarInstruccionesGoogleSheets(datos, config) {
            const instrucciones = document.createElement('div');
            instrucciones.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 1000;
                max-width: 80%;
                max-height: 80%;
                overflow-y: auto;
            `;
            
            instrucciones.innerHTML = `
                <h3>üìã Instrucciones para Google Sheets</h3>
                <p><strong>1.</strong> Se abri√≥ una nueva ventana con tu template</p>
                <p><strong>2.</strong> Haz clic en "Crear una copia"</p>
                <p><strong>3.</strong> N√≥mbrala: <code>Cotizaci√≥n_${config.nombreProyecto}_${new Date().toISOString().slice(0, 10)}</code></p>
                <p><strong>4.</strong> Usa los datos de abajo para llenar las celdas:</p>
                
                <h4>üèóÔ∏è Arquitectura T√©cnica:</h4>
                <textarea readonly style="width: 100%; height: 100px;">
${datos.componentes.filter(c => c.categoria === 'frontend' || c.categoria === 'backend' || c.categoria === 'devops')
    .map(c => `${c.componente}\t${c.buildingBlocks}\t1\t${Math.round(c.costoClienteIntermedio * 0.6)}\t${Math.round(c.horasIAIntermedio * 100)}\t${c.horasIAIntermedio}\t${Math.round(c.costoClienteIntermedio * 0.6)}\t1\t${Math.round(c.costoClienteIntermedio * 0.4)}\t${Math.round(c.horasIAIntermedio * 2)}\tHerramientas Dev\t${Math.round(c.costoClienteIntermedio * 0.4)}\t${config.markupCliente}%\t${Math.round(c.costoClienteIntermedio)}`)
    .join('\n')}
                </textarea>
                
                <h4>‚öôÔ∏è Requisitos Funcionales:</h4>
                <textarea readonly style="width: 100%; height: 100px;">
${datos.componentes.filter(c => c.categoria !== 'frontend' && c.categoria !== 'backend' && c.categoria !== 'devops')
    .map(c => `${c.componente}\t${c.buildingBlocks}\t1\t${Math.round(c.costoClienteIntermedio * 0.6)}\t${Math.round(c.horasIAIntermedio * 100)}\t${c.horasIAIntermedio}\t${Math.round(c.costoClienteIntermedio * 0.6)}\t1\t${Math.round(c.costoClienteIntermedio * 0.4)}\t${Math.round(c.horasIAIntermedio * 2)}\tHerramientas Dev\t${Math.round(c.costoClienteIntermedio * 0.4)}\t${config.markupCliente}%\t${Math.round(c.costoClienteIntermedio)}`)
    .join('\n')}
                </textarea>
                
                <p><strong>5.</strong> Selecciona y copia cada secci√≥n</p>
                <p><strong>6.</strong> Pega en las filas correspondientes del Google Sheet</p>
                
                <button onclick="this.parentElement.remove()" style="
                    background: #4285f4;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 5px;
                    cursor: pointer;
                    margin-top: 10px;
                ">Cerrar</button>
            `;
            
            document.body.appendChild(instrucciones);
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function mostrarMensaje(mensaje, tipo) {
            const div = document.createElement('div');
            div.className = tipo;
            div.textContent = mensaje;
            
            const container = document.querySelector('.container');
            container.appendChild(div);
            
            setTimeout(() => div.remove(), 5000);
        }
    </script>
</body>
</html>
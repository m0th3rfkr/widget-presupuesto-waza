{
  "name": "Budget Widget Fixed",
  "nodes": [
    {
      "parameters": {
        "path": "budget-quote",
        "options": {}
      },
      "id": "webhook-node-001",
      "name": "Budget Webhook",
      "type": "n8n-nodes-base.webhook", 
      "typeVersion": 1.1,
      "position": [200, 300],
      "webhookId": "budget-webhook-unique"
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "// Budget Processing Logic\nconst items = $input.all();\nconst data = items[0].json;\n\n// Extract input data\nconst buildingBlocks = data.building_blocks || {};\nconst config = data.config || {};\n\n// Initialize results\nconst processed = {\n  project_name: config.nombreProyecto || 'Proyecto Sin Nombre',\n  generated_at: new Date().toISOString(),\n  categories: {},\n  totals: { basic: 0, standard: 0, enterprise: 0 },\n  config: config\n};\n\n// Process categories\nif (buildingBlocks.categories) {\n  for (const [categoryId, category] of Object.entries(buildingBlocks.categories)) {\n    const categoryData = {\n      name: category.name || categoryId,\n      items: 0,\n      hours: { basic: 0, standard: 0, enterprise: 0 },\n      costs: { basic: 0, standard: 0, enterprise: 0 }\n    };\n    \n    if (category.building_blocks) {\n      for (const [blockId, block] of Object.entries(category.building_blocks)) {\n        if (block.hours) {\n          // Configuration\n          const efficiency = (100 - (config.eficienciaIA || 35)) / 100;\n          const markup = (100 + (config.markup || 40)) / 100;\n          const aiRate = config.tarifaIA || 300;\n          \n          // Calculate hours with AI efficiency\n          const basicHours = (block.hours.facil || 0) * efficiency;\n          const standardHours = (block.hours.intermedio || 0) * efficiency;\n          const enterpriseHours = (block.hours.complejo || 0) * efficiency;\n          \n          // Calculate costs\n          const basicCost = basicHours * aiRate * markup;\n          const standardCost = standardHours * aiRate * markup;\n          const enterpriseCost = enterpriseHours * aiRate * markup;\n          \n          // Add to category\n          categoryData.hours.basic += basicHours;\n          categoryData.hours.standard += standardHours;\n          categoryData.hours.enterprise += enterpriseHours;\n          \n          categoryData.costs.basic += basicCost;\n          categoryData.costs.standard += standardCost;\n          categoryData.costs.enterprise += enterpriseCost;\n          \n          categoryData.items++;\n        }\n      }\n    }\n    \n    processed.categories[category.name || categoryId] = categoryData;\n    processed.totals.basic += categoryData.costs.basic;\n    processed.totals.standard += categoryData.costs.standard;\n    processed.totals.enterprise += categoryData.costs.enterprise;\n  }\n}\n\n// Apply project factors\nconst pmFactor = (config.factorPM || 18) / 100;\nconst testingFactor = (config.factorTesting || 12) / 100;\nconst contingencyFactor = (config.factorContingencia || 20) / 100;\nconst totalFactor = pmFactor + testingFactor + contingencyFactor;\n\nprocessed.totals.basic *= (1 + totalFactor);\nprocessed.totals.standard *= (1 + totalFactor);\nprocessed.totals.enterprise *= (1 + totalFactor);\n\n// Generate files\nconst markdown = `# Cotización ${processed.project_name}\\n\\n*Generado el ${processed.generated_at}*\\n\\n## Resumen Ejecutivo\\n\\n| Nivel | Costo Total |\\n|-------|-------------|\\n| Básico | $${Math.round(processed.totals.basic).toLocaleString()} MXN |\\n| Estándar | $${Math.round(processed.totals.standard).toLocaleString()} MXN |\\n| Enterprise | $${Math.round(processed.totals.enterprise).toLocaleString()} MXN |`;\n\nreturn [{\n  status: 'success',\n  message: 'Budget processed successfully with AI',\n  data: {\n    processed: processed,\n    markdown: markdown,\n    filename: `cotizacion_${processed.project_name.replace(/\\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}`\n  },\n  timestamp: new Date().toISOString()\n}];"
      },
      "id": "code-node-002",
      "name": "Budget Processor",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [400, 300]
    }
  ],
  "connections": {
    "Budget Webhook": {
      "main": [
        [
          {
            "node": "Budget Processor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1"
}
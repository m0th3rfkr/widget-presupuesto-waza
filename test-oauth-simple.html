<!DOCTYPE html>
<html>
<head>
    <title>ğŸ” Test OAuth Google - SIMPLE</title>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <h1>ğŸ” Test AutenticaciÃ³n OAuth Google</h1>

    <div id="status">ğŸ”„ Inicializando...</div>

    <br><br>
    <button id="signin-btn" onclick="signIn()" disabled>ğŸ”‘ Login Google</button>
    <button id="signout-btn" onclick="signOut()" disabled>ğŸšª Logout</button>

    <br><br>
    <button id="test-drive" onclick="testDrive()" disabled>ğŸ“ Test Drive API</button>
    <button id="test-sheets" onclick="testSheets()" disabled>ğŸ“Š Test Sheets API</button>

    <div id="logs" style="margin-top: 20px; background: #f0f0f0; padding: 10px; font-family: monospace; max-height: 400px; overflow-y: auto;"></div>

    <script>
        // ConfiguraciÃ³n OAuth
        const CLIENT_ID = '64644619494-tous9hjfmhdpmcfnj18b067tnj3ve9f9.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyA5WkzYdrn2v24fgB1rln5qnbhs7iivFNs';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets';

        let authInstance = null;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
            log(`STATUS: ${message}`);
        }

        function updateButtons(isSignedIn) {
            document.getElementById('signin-btn').disabled = isSignedIn;
            document.getElementById('signout-btn').disabled = !isSignedIn;
            document.getElementById('test-drive').disabled = !isSignedIn;
            document.getElementById('test-sheets').disabled = !isSignedIn;
        }

        // Inicializar Google API
        function initClient() {
            updateStatus('ğŸ”„ Cargando Google API...');

            // Verificar dominio actual
            const currentOrigin = window.location.origin;
            log(`ğŸŒ Dominio actual: ${currentOrigin}`);

            gapi.load('auth2:client', () => {
                log('âœ… GAPI cargado, inicializando cliente...');
                log(`ğŸ”‘ Client ID: ${CLIENT_ID}`);
                log(`ğŸ—ï¸ API Key: ${API_KEY.substring(0, 10)}...`);
                log(`ğŸ” Scopes: ${SCOPES}`);

                gapi.client.init({
                    apiKey: API_KEY,
                    clientId: CLIENT_ID,
                    discoveryDocs: [
                        'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                        'https://sheets.googleapis.com/$discovery/rest?version=v4'
                    ],
                    scope: SCOPES
                }).then(() => {
                    log('âœ… Cliente Google API inicializado correctamente');

                    authInstance = gapi.auth2.getAuthInstance();

                    // Verificar si ya estÃ¡ autenticado
                    const isSignedIn = authInstance.isSignedIn.get();
                    log(`ğŸ” Estado autenticaciÃ³n inicial: ${isSignedIn ? 'Autenticado' : 'No autenticado'}`);

                    if (isSignedIn) {
                        const user = authInstance.currentUser.get();
                        const profile = user.getBasicProfile();
                        updateStatus(`âœ… Ya autenticado como: ${profile.getEmail()}`);
                    } else {
                        updateStatus('âš ï¸ No autenticado - Click "Login Google"');
                    }

                    updateButtons(isSignedIn);

                    // Listener para cambios de autenticaciÃ³n
                    authInstance.isSignedIn.listen((isSignedIn) => {
                        log(`ğŸ”„ Cambio de autenticaciÃ³n: ${isSignedIn}`);
                        updateButtons(isSignedIn);

                        if (isSignedIn) {
                            const user = authInstance.currentUser.get();
                            const profile = user.getBasicProfile();
                            updateStatus(`âœ… Autenticado como: ${profile.getEmail()}`);
                        } else {
                            updateStatus('âŒ SesiÃ³n cerrada');
                        }
                    });

                }).catch((error) => {
                    log(`âŒ Error inicializando cliente: ${JSON.stringify(error)}`);
                    log(`âŒ Error message: ${error.message || 'Sin mensaje'}`);
                    log(`âŒ Error details: ${error.details || 'Sin detalles'}`);
                    log(`âŒ Error result: ${JSON.stringify(error.result || {})}`);
                    updateStatus('âŒ Error inicializando Google API');
                    console.error('Error details:', error);
                    console.error('Error stringified:', JSON.stringify(error, null, 2));
                });
            });
        }

        // Login
        function signIn() {
            log('ğŸ”‘ Iniciando proceso de login...');
            updateStatus('ğŸ”„ Solicitando autorizaciÃ³n...');

            authInstance.signIn({
                prompt: 'select_account'
            }).then(() => {
                log('âœ… Login completado exitosamente');
                const user = authInstance.currentUser.get();
                const profile = user.getBasicProfile();
                log(`ğŸ‘¤ Usuario: ${profile.getName()} (${profile.getEmail()})`);

                // Verificar scopes otorgados
                const grantedScopes = user.getGrantedScopes();
                log(`ğŸ”‘ Scopes otorgados: ${grantedScopes}`);

            }).catch((error) => {
                log(`âŒ Error en login: ${error}`);
                updateStatus('âŒ Error en autenticaciÃ³n');
                console.error('Login error:', error);
            });
        }

        // Logout
        function signOut() {
            log('ğŸšª Cerrando sesiÃ³n...');
            authInstance.signOut().then(() => {
                log('âœ… SesiÃ³n cerrada correctamente');
            });
        }

        // Test Drive API
        async function testDrive() {
            log('ğŸ“ Probando Drive API...');

            try {
                const response = await gapi.client.drive.files.list({
                    pageSize: 5,
                    fields: 'files(id, name, mimeType)'
                });

                const files = response.result.files;
                log(`âœ… Drive API OK - Encontrados ${files.length} archivos:`);

                files.forEach(file => {
                    log(`  ğŸ“„ ${file.name} (${file.id})`);
                });

            } catch (error) {
                log(`âŒ Error en Drive API: ${error.message}`);
                console.error('Drive error:', error);
            }
        }

        // Test Sheets API
        async function testSheets() {
            log('ğŸ“Š Probando Sheets API...');

            try {
                // Template ID del proyecto
                const templateId = '1n8BAmL0zJOZrW1MQYo4JGj3YEJtvOhV0y2Wm8KqQVHE';

                log(`ğŸ” Intentando acceder al template: ${templateId}`);

                const response = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: templateId
                });

                log(`âœ… Sheets API OK - Template encontrado:`);
                log(`  ğŸ“Š TÃ­tulo: ${response.result.properties.title}`);
                log(`  ğŸ“„ Sheets: ${response.result.sheets.length}`);

                response.result.sheets.forEach(sheet => {
                    log(`    - ${sheet.properties.title}`);
                });

            } catch (error) {
                log(`âŒ Error en Sheets API: ${error.message}`);
                console.error('Sheets error:', error);
            }
        }

        // Inicializar cuando cargue la pÃ¡gina
        window.onload = initClient;
    </script>
</body>
</html>
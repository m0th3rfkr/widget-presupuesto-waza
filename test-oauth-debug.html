<!DOCTYPE html>
<html>
<head>
    <title>üîß Debug OAuth Google - PASO A PASO</title>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <h1>üîß Debug Autenticaci√≥n OAuth Google</h1>

    <div id="status">üîÑ Inicializando...</div>

    <br><br>
    <button onclick="step1LoadGapi()">1Ô∏è‚É£ Cargar GAPI</button>
    <button onclick="step2InitClient()">2Ô∏è‚É£ Init Client</button>
    <button onclick="step3CheckAuth()">3Ô∏è‚É£ Check Auth</button>
    <button onclick="step4SignIn()">4Ô∏è‚É£ Sign In</button>

    <div id="logs" style="margin-top: 20px; background: #f0f0f0; padding: 10px; font-family: monospace; max-height: 400px; overflow-y: auto;"></div>

    <script>
        let step = 0;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
            log(`STATUS: ${message}`);
        }

        // PASO 1: Verificar que GAPI se carga
        function step1LoadGapi() {
            log('üîÑ PASO 1: Verificando carga de GAPI...');

            if (typeof gapi === 'undefined') {
                log('‚ùå GAPI no est√° disponible');
                return;
            }

            log('‚úÖ GAPI disponible');
            log(`üì¶ Versi√≥n GAPI: ${gapi.version || 'No disponible'}`);

            // Verificar dominio
            log(`üåê Dominio: ${window.location.origin}`);
            log(`üìÑ URL completa: ${window.location.href}`);

            updateStatus('‚úÖ PASO 1 completado - GAPI cargado');
            step = 1;
        }

        // PASO 2: Cargar m√≥dulos necesarios
        function step2InitClient() {
            if (step < 1) {
                log('‚ùå Ejecuta PASO 1 primero');
                return;
            }

            log('üîÑ PASO 2: Cargando m√≥dulos auth2:client...');

            gapi.load('auth2:client', {
                callback: () => {
                    log('‚úÖ M√≥dulos auth2:client cargados correctamente');
                    updateStatus('‚úÖ PASO 2 completado - M√≥dulos cargados');
                    step = 2;
                },
                onerror: (error) => {
                    log(`‚ùå Error cargando m√≥dulos: ${JSON.stringify(error)}`);
                    updateStatus('‚ùå PASO 2 fall√≥');
                }
            });
        }

        // PASO 3: Inicializar cliente con configuraci√≥n m√≠nima
        function step3CheckAuth() {
            if (step < 2) {
                log('‚ùå Ejecuta PASO 2 primero');
                return;
            }

            log('üîÑ PASO 3: Inicializando cliente Google...');

            // Configuraci√≥n simplificada
            const config = {
                apiKey: 'AIzaSyA5WkzYdrn2v24fgB1rln5qnbhs7iivFNs',
                clientId: '64644619494-tous9hjfmhdpmcfnj18b067tnj3ve9f9.apps.googleusercontent.com',
                scope: 'https://www.googleapis.com/auth/drive.file'
            };

            log(`üîë Client ID: ${config.clientId}`);
            log(`üóùÔ∏è API Key: ${config.apiKey.substring(0, 20)}...`);
            log(`üîê Scope: ${config.scope}`);

            gapi.client.init(config).then(() => {
                log('‚úÖ Cliente inicializado correctamente');

                // Verificar auth2
                const authInstance = gapi.auth2.getAuthInstance();
                if (authInstance) {
                    log('‚úÖ Auth instance obtenida');
                    const isSignedIn = authInstance.isSignedIn.get();
                    log(`üîç Estado autenticaci√≥n: ${isSignedIn ? 'Autenticado' : 'No autenticado'}`);
                } else {
                    log('‚ùå No se pudo obtener auth instance');
                }

                updateStatus('‚úÖ PASO 3 completado - Cliente inicializado');
                step = 3;

            }).catch((error) => {
                log('‚ùå Error en inicializaci√≥n:');
                log(`  - Message: ${error.message || 'N/A'}`);
                log(`  - Details: ${error.details || 'N/A'}`);
                log(`  - Result: ${JSON.stringify(error.result || {})}`);
                log(`  - Full error: ${JSON.stringify(error)}`);

                console.error('Full error object:', error);
                updateStatus('‚ùå PASO 3 fall√≥');
            });
        }

        // PASO 4: Probar sign-in
        function step4SignIn() {
            if (step < 3) {
                log('‚ùå Ejecuta PASO 3 primero');
                return;
            }

            log('üîÑ PASO 4: Probando sign-in...');

            const authInstance = gapi.auth2.getAuthInstance();
            if (!authInstance) {
                log('‚ùå No hay auth instance disponible');
                return;
            }

            authInstance.signIn({
                prompt: 'select_account'
            }).then(() => {
                log('‚úÖ Sign-in exitoso');

                const user = authInstance.currentUser.get();
                const profile = user.getBasicProfile();
                log(`üë§ Usuario: ${profile.getName()}`);
                log(`üìß Email: ${profile.getEmail()}`);

                const grantedScopes = user.getGrantedScopes();
                log(`üîë Scopes otorgados: ${grantedScopes}`);

                updateStatus('‚úÖ PASO 4 completado - Autenticado');
                step = 4;

            }).catch((error) => {
                log(`‚ùå Error en sign-in: ${JSON.stringify(error)}`);
                console.error('Sign-in error:', error);
                updateStatus('‚ùå PASO 4 fall√≥');
            });
        }

        // Auto-ejecutar paso 1 al cargar
        window.onload = () => {
            log('üöÄ P√°gina cargada');
            updateStatus('üîÑ Listo para debugging');
            setTimeout(step1LoadGapi, 1000);
        };
    </script>
</body>
</html>
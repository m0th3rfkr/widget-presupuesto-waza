<!DOCTYPE html>
<html>
<head>
    <title>üöÄ Test OAuth Google - Nueva API (GIS)</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <h1>üöÄ Test OAuth Google - Nueva API (GIS)</h1>

    <div id="status">üîÑ Inicializando...</div>

    <br><br>
    <div id="buttonDiv"></div>
    <button id="signout-btn" onclick="signOut()" disabled>üö™ Cerrar Sesi√≥n</button>

    <br><br>
    <button id="test-drive" onclick="testDrive()" disabled>üìÅ Test Drive API</button>
    <button id="test-sheets" onclick="testSheets()" disabled>üìä Test Sheets API</button>

    <div id="logs" style="margin-top: 20px; background: #f0f0f0; padding: 10px; font-family: monospace; max-height: 400px; overflow-y: auto;"></div>

    <script>
        // Configuraci√≥n
        const CLIENT_ID = '64644619494-tous9hjfmhdpmcfnj18b067tnj3ve9f9.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyA5WkzYdrn2v24fgB1rln5qnbhs7iivFNs';
        const SCOPES = 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/spreadsheets';

        let tokenClient;
        let accessToken = null;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
            log(`STATUS: ${message}`);
        }

        function updateButtons(isSignedIn) {
            document.getElementById('signout-btn').disabled = !isSignedIn;
            document.getElementById('test-drive').disabled = !isSignedIn;
            document.getElementById('test-sheets').disabled = !isSignedIn;
        }

        // Inicializar Google Identity Services
        function initializeGIS() {
            updateStatus('üîÑ Inicializando Google Identity Services...');
            log('üöÄ Configurando nueva Google Identity Services API');

            log(`üîë Client ID: ${CLIENT_ID}`);
            log(`üóùÔ∏è API Key: ${API_KEY.substring(0, 20)}...`);
            log(`üîê Scopes: ${SCOPES}`);

            // Inicializar cliente de tokens
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    log('‚úÖ Token recibido exitosamente');
                    log(`üé´ Access token: ${tokenResponse.access_token.substring(0, 20)}...`);

                    accessToken = tokenResponse.access_token;
                    gapi.client.setToken({ access_token: accessToken });

                    updateStatus('‚úÖ Autenticado correctamente con Google Identity Services');
                    updateButtons(true);

                    log('üéâ Proceso de autenticaci√≥n completado');
                },
                error_callback: (error) => {
                    log(`‚ùå Error en token: ${JSON.stringify(error)}`);
                    updateStatus('‚ùå Error en autenticaci√≥n');
                    updateButtons(false);
                }
            });

            // Crear bot√≥n de login
            google.accounts.id.initialize({
                client_id: CLIENT_ID,
                callback: handleCredentialResponse
            });

            // Bot√≥n personalizado para OAuth
            const buttonDiv = document.getElementById('buttonDiv');
            buttonDiv.innerHTML = '<button onclick="requestAccessToken()" style="padding: 10px 20px; font-size: 16px;">üîë Autorizar Google APIs</button>';

            updateStatus('‚úÖ Google Identity Services inicializado - Click para autorizar');
            log('‚úÖ GIS inicializado correctamente');
        }

        // Solicitar token de acceso
        function requestAccessToken() {
            log('üîë Solicitando token de acceso...');
            updateStatus('üîÑ Solicitando autorizaci√≥n...');

            // Verificar si ya tenemos token v√°lido
            if (accessToken) {
                log('‚ö†Ô∏è Ya existe un token, revocando primero...');
                google.accounts.oauth2.revoke(accessToken, () => {
                    log('üóëÔ∏è Token anterior revocado');
                });
            }

            tokenClient.requestAccessToken({
                prompt: 'consent'
            });
        }

        // Manejar respuesta de credenciales (para ID token)
        function handleCredentialResponse(response) {
            log('üÜî ID Token recibido');
            // Este es solo para identificaci√≥n, no para APIs
        }

        // Cerrar sesi√≥n
        function signOut() {
            log('üö™ Cerrando sesi√≥n...');

            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken, () => {
                    log('‚úÖ Token revocado');
                    accessToken = null;
                    gapi.client.setToken(null);
                    updateStatus('‚úÖ Sesi√≥n cerrada');
                    updateButtons(false);
                });
            }
        }

        // Inicializar Google API Client
        function initGAPI() {
            log('üìö Inicializando Google API Client...');

            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [
                        'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                        'https://sheets.googleapis.com/$discovery/rest?version=v4'
                    ]
                });

                log('‚úÖ Google API Client inicializado');
                initializeGIS(); // Inicializar GIS despu√©s de GAPI
            });
        }

        // Test Drive API
        async function testDrive() {
            log('üìÅ Probando Drive API...');

            try {
                const response = await gapi.client.drive.files.list({
                    pageSize: 5,
                    fields: 'files(id, name, mimeType)'
                });

                const files = response.result.files;
                log(`‚úÖ Drive API OK - Encontrados ${files.length} archivos:`);

                files.forEach(file => {
                    log(`  üìÑ ${file.name} (${file.id})`);
                });

            } catch (error) {
                log(`‚ùå Error en Drive API: ${error.message}`);
                console.error('Drive error:', error);
            }
        }

        // Test Sheets API
        async function testSheets() {
            log('üìä Probando Sheets API...');

            try {
                // Template ID del proyecto (actualizado - copia propia)
                const templateId = '1wR49oqHn3NdKj9pFzMdM2fpFpcYx7CxIZhLUHolWcA4';

                log(`üîç Intentando acceder al template: ${templateId}`);

                // Primero probar acceso directo
                try {
                    const response = await gapi.client.sheets.spreadsheets.get({
                        spreadsheetId: templateId
                    });

                    log(`‚úÖ Sheets API OK - Template encontrado:`);
                    log(`  üìä T√≠tulo: ${response.result.properties.title}`);
                    log(`  üìÑ Sheets: ${response.result.sheets.length}`);

                    response.result.sheets.forEach(sheet => {
                        log(`    - ${sheet.properties.title}`);
                    });

                } catch (sheetError) {
                    log(`‚ö†Ô∏è No se puede acceder al template directamente: ${sheetError.message}`);
                    log(`üîÑ Intentando crear sheet nuevo desde cero...`);

                    // Crear un nuevo spreadsheet en lugar de copiar
                    const createResponse = await gapi.client.sheets.spreadsheets.create({
                        resource: {
                            properties: {
                                title: `Presupuesto Test - ${new Date().toLocaleString()}`
                            },
                            sheets: [{
                                properties: {
                                    title: 'Presupuesto',
                                    gridProperties: {
                                        rowCount: 100,
                                        columnCount: 15
                                    }
                                }
                            }]
                        }
                    });

                    const newSheetId = createResponse.result.spreadsheetId;
                    log(`‚úÖ Nuevo sheet creado: ${newSheetId}`);

                    // Agregar datos de prueba
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: newSheetId,
                        range: 'A1:C3',
                        valueInputOption: 'RAW',
                        resource: {
                            values: [
                                ['Proyecto', 'Cliente', 'Fecha'],
                                ['Proyecto Test OAuth', 'Cliente Test', new Date().toLocaleDateString()],
                                ['Estado:', '‚úÖ OAuth funcionando!', 'üöÄ GIS implementado']
                            ]
                        }
                    });

                    log(`‚úÖ Datos de prueba agregados`);

                    const newSheetUrl = `https://docs.google.com/spreadsheets/d/${newSheetId}`;
                    log(`üîó URL: ${newSheetUrl}`);

                    // Abrir en nueva ventana
                    window.open(newSheetUrl, '_blank');
                    return;
                }

                // En lugar de copiar, crear nuevo sheet con estructura del template
                log('üîÑ Template accesible, creando nuevo sheet con su estructura...');

                // Leer datos del template
                const templateData = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: templateId,
                    range: 'A1:Z100' // Rango amplio para capturar todo
                });

                log(`üìÑ Datos del template obtenidos: ${templateData.result.values ? templateData.result.values.length : 0} filas`);

                // Crear nuevo spreadsheet
                const createResponse = await gapi.client.sheets.spreadsheets.create({
                    resource: {
                        properties: {
                            title: `Presupuesto Copy - ${new Date().toLocaleString()}`
                        },
                        sheets: [{
                            properties: {
                                title: 'Presupuesto',
                                gridProperties: {
                                    rowCount: 1000,
                                    columnCount: 26
                                }
                            }
                        }]
                    }
                });

                const newSheetId = createResponse.result.spreadsheetId;
                log(`‚úÖ Nuevo sheet creado: ${newSheetId}`);

                // Copiar datos del template al nuevo sheet
                if (templateData.result.values && templateData.result.values.length > 0) {
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: newSheetId,
                        range: 'A1',
                        valueInputOption: 'RAW',
                        resource: {
                            values: templateData.result.values
                        }
                    });
                    log(`‚úÖ Datos copiados: ${templateData.result.values.length} filas`);
                } else {
                    log('‚ö†Ô∏è No se encontraron datos en el template, creando estructura b√°sica...');
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: newSheetId,
                        range: 'A1:C3',
                        valueInputOption: 'RAW',
                        resource: {
                            values: [
                                ['PRESUPUESTO WAZA', '', ''],
                                ['Proyecto:', '[NOMBRE_PROYECTO]', ''],
                                ['Cliente:', '[NOMBRE_CLIENTE]', '']
                            ]
                        }
                    });
                }

                const newSheetUrl = `https://docs.google.com/spreadsheets/d/${newSheetId}`;
                log(`üîó URL: ${newSheetUrl}`);

                // Abrir en nueva ventana
                window.open(newSheetUrl, '_blank');

            } catch (error) {
                log(`‚ùå Error general en Sheets API: ${error.message || error}`);
                log(`üìù Detalles completos: ${JSON.stringify(error)}`);
                console.error('Sheets error:', error);
            }
        }

        // Inicializar cuando cargue la p√°gina
        window.onload = function() {
            log('üöÄ P√°gina cargada');
            updateStatus('üîÑ Cargando APIs...');
            initGAPI();
        };
    </script>
</body>
</html>
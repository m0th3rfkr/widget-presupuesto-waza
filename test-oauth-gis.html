<!DOCTYPE html>
<html>
<head>
    <title>üöÄ Test OAuth Google - Nueva API (GIS)</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <h1>üöÄ Test OAuth Google - Nueva API (GIS)</h1>

    <div id="status">üîÑ Inicializando...</div>

    <br><br>
    <div id="buttonDiv"></div>
    <button id="signout-btn" onclick="signOut()" disabled>üö™ Cerrar Sesi√≥n</button>

    <br><br>
    <button id="test-drive" onclick="testDrive()" disabled>üìÅ Test Drive API</button>
    <button id="test-sheets" onclick="testSheets()" disabled>üìä Test Sheets API</button>

    <div id="logs" style="margin-top: 20px; background: #f0f0f0; padding: 10px; font-family: monospace; max-height: 400px; overflow-y: auto;"></div>

    <script>
        // Configuraci√≥n
        const CLIENT_ID = '64644619494-tous9hjfmhdpmcfnj18b067tnj3ve9f9.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyA5WkzYdrn2v24fgB1rln5qnbhs7iivFNs';
        const SCOPES = 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/spreadsheets';

        let tokenClient;
        let accessToken = null;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
            log(`STATUS: ${message}`);
        }

        function updateButtons(isSignedIn) {
            document.getElementById('signout-btn').disabled = !isSignedIn;
            document.getElementById('test-drive').disabled = !isSignedIn;
            document.getElementById('test-sheets').disabled = !isSignedIn;
        }

        // Inicializar Google Identity Services
        function initializeGIS() {
            updateStatus('üîÑ Inicializando Google Identity Services...');
            log('üöÄ Configurando nueva Google Identity Services API');

            log(`üîë Client ID: ${CLIENT_ID}`);
            log(`üóùÔ∏è API Key: ${API_KEY.substring(0, 20)}...`);
            log(`üîê Scopes: ${SCOPES}`);

            // Inicializar cliente de tokens
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    log('‚úÖ Token recibido exitosamente');
                    log(`üé´ Access token: ${tokenResponse.access_token.substring(0, 20)}...`);

                    accessToken = tokenResponse.access_token;
                    gapi.client.setToken({ access_token: accessToken });

                    updateStatus('‚úÖ Autenticado correctamente con Google Identity Services');
                    updateButtons(true);

                    log('üéâ Proceso de autenticaci√≥n completado');
                },
                error_callback: (error) => {
                    log(`‚ùå Error en token: ${JSON.stringify(error)}`);
                    updateStatus('‚ùå Error en autenticaci√≥n');
                    updateButtons(false);
                }
            });

            // Crear bot√≥n de login
            google.accounts.id.initialize({
                client_id: CLIENT_ID,
                callback: handleCredentialResponse
            });

            // Bot√≥n personalizado para OAuth
            const buttonDiv = document.getElementById('buttonDiv');
            buttonDiv.innerHTML = '<button onclick="requestAccessToken()" style="padding: 10px 20px; font-size: 16px;">üîë Autorizar Google APIs</button>';

            updateStatus('‚úÖ Google Identity Services inicializado - Click para autorizar');
            log('‚úÖ GIS inicializado correctamente');
        }

        // Solicitar token de acceso
        function requestAccessToken() {
            log('üîë Solicitando token de acceso...');
            updateStatus('üîÑ Solicitando autorizaci√≥n...');

            // Verificar si ya tenemos token v√°lido
            if (accessToken) {
                log('‚ö†Ô∏è Ya existe un token, revocando primero...');
                google.accounts.oauth2.revoke(accessToken, () => {
                    log('üóëÔ∏è Token anterior revocado');
                });
            }

            tokenClient.requestAccessToken({
                prompt: 'consent'
            });
        }

        // Manejar respuesta de credenciales (para ID token)
        function handleCredentialResponse(response) {
            log('üÜî ID Token recibido');
            // Este es solo para identificaci√≥n, no para APIs
        }

        // Cerrar sesi√≥n
        function signOut() {
            log('üö™ Cerrando sesi√≥n...');

            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken, () => {
                    log('‚úÖ Token revocado');
                    accessToken = null;
                    gapi.client.setToken(null);
                    updateStatus('‚úÖ Sesi√≥n cerrada');
                    updateButtons(false);
                });
            }
        }

        // Inicializar Google API Client
        function initGAPI() {
            log('üìö Inicializando Google API Client...');

            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [
                        'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                        'https://sheets.googleapis.com/$discovery/rest?version=v4'
                    ]
                });

                log('‚úÖ Google API Client inicializado');
                initializeGIS(); // Inicializar GIS despu√©s de GAPI
            });
        }

        // Test Drive API
        async function testDrive() {
            log('üìÅ Probando Drive API...');

            try {
                const response = await gapi.client.drive.files.list({
                    pageSize: 5,
                    fields: 'files(id, name, mimeType)'
                });

                const files = response.result.files;
                log(`‚úÖ Drive API OK - Encontrados ${files.length} archivos:`);

                files.forEach(file => {
                    log(`  üìÑ ${file.name} (${file.id})`);
                });

            } catch (error) {
                log(`‚ùå Error en Drive API: ${error.message}`);
                console.error('Drive error:', error);
            }
        }

        // Test Sheets API
        async function testSheets() {
            log('üìä Probando Sheets API...');

            try {
                // Template ID del proyecto (actualizado - copia propia)
                const templateId = '1wR49oqHn3NdKj9pFzMdM2fpFpcYx7CxIZhLUHolWcA4';

                log(`üîç Intentando acceder al template: ${templateId}`);

                // Primero probar acceso directo
                try {
                    const response = await gapi.client.sheets.spreadsheets.get({
                        spreadsheetId: templateId
                    });

                    log(`‚úÖ Sheets API OK - Template encontrado:`);
                    log(`  üìä T√≠tulo: ${response.result.properties.title}`);
                    log(`  üìÑ Sheets: ${response.result.sheets.length}`);

                    response.result.sheets.forEach(sheet => {
                        log(`    - ${sheet.properties.title}`);
                    });

                } catch (sheetError) {
                    log(`‚ö†Ô∏è No se puede acceder al template directamente: ${sheetError.message}`);
                    log(`üîÑ Intentando crear sheet nuevo desde cero...`);

                    // Crear un nuevo spreadsheet en lugar de copiar
                    const createResponse = await gapi.client.sheets.spreadsheets.create({
                        resource: {
                            properties: {
                                title: `Presupuesto Test - ${new Date().toLocaleString()}`
                            },
                            sheets: [{
                                properties: {
                                    title: 'Presupuesto',
                                    gridProperties: {
                                        rowCount: 100,
                                        columnCount: 15
                                    }
                                }
                            }]
                        }
                    });

                    const newSheetId = createResponse.result.spreadsheetId;
                    log(`‚úÖ Nuevo sheet creado: ${newSheetId}`);

                    // Agregar datos de prueba
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: newSheetId,
                        range: 'A1:C3',
                        valueInputOption: 'RAW',
                        resource: {
                            values: [
                                ['Proyecto', 'Cliente', 'Fecha'],
                                ['Proyecto Test OAuth', 'Cliente Test', new Date().toLocaleDateString()],
                                ['Estado:', '‚úÖ OAuth funcionando!', 'üöÄ GIS implementado']
                            ]
                        }
                    });

                    log(`‚úÖ Datos de prueba agregados`);

                    const newSheetUrl = `https://docs.google.com/spreadsheets/d/${newSheetId}`;
                    log(`üîó URL: ${newSheetUrl}`);

                    // Abrir en nueva ventana
                    window.open(newSheetUrl, '_blank');
                    return;
                }

                // En lugar de copiar, crear nuevo sheet con estructura COMPLETA del template
                log('üîÑ Template accesible, creando copia completa con formato...');

                // Paso 1: Obtener informaci√≥n completa del template
                const templateInfo = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: templateId
                });

                log(`üìä Template info obtenida: ${templateInfo.result.properties.title}`);

                // Paso 2: Leer datos CON F√ìRMULAS (no solo valores)
                const templateData = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: templateId,
                    range: 'A1:Z100',
                    valueRenderOption: 'FORMULA' // Esto obtiene f√≥rmulas en lugar de valores calculados
                });

                log(`üìÑ Datos con f√≥rmulas obtenidos: ${templateData.result.values ? templateData.result.values.length : 0} filas`);

                // Paso 3: Crear nuevo spreadsheet
                const createResponse = await gapi.client.sheets.spreadsheets.create({
                    resource: {
                        properties: {
                            title: `Presupuesto Copy - ${new Date().toLocaleString()}`
                        },
                        sheets: [{
                            properties: {
                                title: 'Presupuesto',
                                gridProperties: {
                                    rowCount: 1000,
                                    columnCount: 26
                                }
                            }
                        }]
                    }
                });

                const newSheetId = createResponse.result.spreadsheetId;
                log(`‚úÖ Nuevo sheet creado: ${newSheetId}`);

                // Paso 4: Copiar datos CON F√ìRMULAS
                if (templateData.result.values && templateData.result.values.length > 0) {
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: newSheetId,
                        range: 'A1',
                        valueInputOption: 'USER_ENTERED', // Esto interpreta f√≥rmulas
                        resource: {
                            values: templateData.result.values
                        }
                    });
                    log(`‚úÖ Datos y f√≥rmulas copiados: ${templateData.result.values.length} filas`);

                    // Paso 5: Detectar filas din√°micamente y aplicar formato
                    log('üé® Aplicando formato completo del template...');
                    try {
                        const newSheetSheetId = createResponse.result.sheets[0].properties.sheetId;

                        // Detectar filas que contienen patrones de "Requisitos"
                        log('üîç Detectando filas con patrones de Requisitos...');
                        const requisitosRows = [];

                        if (templateData.result.values) {
                            templateData.result.values.forEach((row, index) => {
                                const rowText = row.join(' ').toLowerCase();

                                // Buscar fila "Requisitos Funcionales"
                                if (rowText.includes('requisitos funcionales') &&
                                    rowText.includes('humanos') &&
                                    rowText.includes('markup')) {
                                    requisitosRows.push({
                                        type: 'funcionales',
                                        row: index,
                                        text: 'Requisitos Funcionales'
                                    });
                                    log(`‚úÖ Encontrada fila Requisitos Funcionales en: ${index + 1}`);
                                }

                                // Buscar fila "Requisitos No Funcionales"
                                if (rowText.includes('requisitos no funcionales') &&
                                    rowText.includes('humanos') &&
                                    rowText.includes('markup')) {
                                    requisitosRows.push({
                                        type: 'no_funcionales',
                                        row: index,
                                        text: 'Requisitos No Funcionales'
                                    });
                                    log(`‚úÖ Encontrada fila Requisitos No Funcionales en: ${index + 1}`);
                                }
                            });
                        }

                        log(`üìã Total filas de Requisitos encontradas: ${requisitosRows.length}`);

                        // Formato para headers principales (azul oscuro)
                        await gapi.client.sheets.spreadsheets.batchUpdate({
                            spreadsheetId: newSheetId,
                            resource: {
                                requests: [
                                    // Encabezados principales (CLIENTE, PROYECTO, EJECUTIVO)
                                    {
                                        repeatCell: {
                                            range: {
                                                sheetId: newSheetSheetId,
                                                startRowIndex: 1,
                                                endRowIndex: 4,
                                                startColumnIndex: 1,
                                                endColumnIndex: 3
                                            },
                                            cell: {
                                                userEnteredFormat: {
                                                    backgroundColor: {
                                                        red: 0.26,
                                                        green: 0.52,
                                                        blue: 0.96
                                                    },
                                                    textFormat: {
                                                        bold: true,
                                                        foregroundColor: {
                                                            red: 1,
                                                            green: 1,
                                                            blue: 1
                                                        }
                                                    },
                                                    borders: {
                                                        top: { style: 'SOLID', width: 1 },
                                                        bottom: { style: 'SOLID', width: 1 },
                                                        left: { style: 'SOLID', width: 1 },
                                                        right: { style: 'SOLID', width: 1 }
                                                    }
                                                }
                                            },
                                            fields: 'userEnteredFormat(backgroundColor,textFormat,borders)'
                                        }
                                    },
                                    // Headers de secciones (Arquitectura T√©cnica, etc.)
                                    {
                                        repeatCell: {
                                            range: {
                                                sheetId: newSheetSheetId,
                                                startRowIndex: 4,
                                                endRowIndex: 6,
                                                startColumnIndex: 0,
                                                endColumnIndex: 26
                                            },
                                            cell: {
                                                userEnteredFormat: {
                                                    backgroundColor: {
                                                        red: 0.26,
                                                        green: 0.52,
                                                        blue: 0.96
                                                    },
                                                    textFormat: {
                                                        bold: true,
                                                        foregroundColor: {
                                                            red: 1,
                                                            green: 1,
                                                            blue: 1
                                                        }
                                                    }
                                                }
                                            },
                                            fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                        }
                                    },
                                    // Headers HUMANOS (solo t√≠tulos en rojo)
                                    {
                                        repeatCell: {
                                            range: {
                                                sheetId: newSheetSheetId,
                                                startRowIndex: 4,
                                                endRowIndex: 6,
                                                startColumnIndex: 7,
                                                endColumnIndex: 12
                                            },
                                            cell: {
                                                userEnteredFormat: {
                                                    backgroundColor: {
                                                        red: 0.98,
                                                        green: 0.4,
                                                        blue: 0.4
                                                    },
                                                    textFormat: {
                                                        bold: true,
                                                        foregroundColor: {
                                                            red: 1,
                                                            green: 1,
                                                            blue: 1
                                                        }
                                                    }
                                                }
                                            },
                                            fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                        }
                                    },
                                    // Headers AI (solo t√≠tulos en verde)
                                    {
                                        repeatCell: {
                                            range: {
                                                sheetId: newSheetSheetId,
                                                startRowIndex: 4,
                                                endRowIndex: 6,
                                                startColumnIndex: 2,
                                                endColumnIndex: 7
                                            },
                                            cell: {
                                                userEnteredFormat: {
                                                    backgroundColor: {
                                                        red: 0.34,
                                                        green: 0.73,
                                                        blue: 0.34
                                                    },
                                                    textFormat: {
                                                        bold: true,
                                                        foregroundColor: {
                                                            red: 1,
                                                            green: 1,
                                                            blue: 1
                                                        }
                                                    }
                                                }
                                            },
                                            fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                        }
                                    },
                                    // Continuaci√≥n HUMANOS (rojo) - columnas 12 (M) hasta antes de MARKUP
                                    {
                                        repeatCell: {
                                            range: {
                                                sheetId: newSheetSheetId,
                                                startRowIndex: 4,
                                                endRowIndex: 6,
                                                startColumnIndex: 12,
                                                endColumnIndex: 13
                                            },
                                            cell: {
                                                userEnteredFormat: {
                                                    backgroundColor: {
                                                        red: 0.98,
                                                        green: 0.4,
                                                        blue: 0.4
                                                    },
                                                    textFormat: {
                                                        bold: true,
                                                        foregroundColor: {
                                                            red: 1,
                                                            green: 1,
                                                            blue: 1
                                                        }
                                                    }
                                                }
                                            },
                                            fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                        }
                                    },
                                    // Header MARKUP (amarillo) - columna 13 (N)
                                    {
                                        repeatCell: {
                                            range: {
                                                sheetId: newSheetSheetId,
                                                startRowIndex: 4,
                                                endRowIndex: 6,
                                                startColumnIndex: 13,
                                                endColumnIndex: 14
                                            },
                                            cell: {
                                                userEnteredFormat: {
                                                    backgroundColor: {
                                                        red: 1,
                                                        green: 0.95,
                                                        blue: 0.4
                                                    },
                                                    textFormat: {
                                                        bold: true,
                                                        foregroundColor: {
                                                            red: 0,
                                                            green: 0,
                                                            blue: 0
                                                        }
                                                    }
                                                }
                                            },
                                            fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                        }
                                    },
                                    // Resto header principal (azul) - columnas 14+
                                    {
                                        repeatCell: {
                                            range: {
                                                sheetId: newSheetSheetId,
                                                startRowIndex: 4,
                                                endRowIndex: 6,
                                                startColumnIndex: 14,
                                                endColumnIndex: 26
                                            },
                                            cell: {
                                                userEnteredFormat: {
                                                    backgroundColor: {
                                                        red: 0.26,
                                                        green: 0.52,
                                                        blue: 0.96
                                                    },
                                                    textFormat: {
                                                        bold: true,
                                                        foregroundColor: {
                                                            red: 1,
                                                            green: 1,
                                                            blue: 1
                                                        }
                                                    }
                                                }
                                            },
                                            fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                        }
                                    },
                                    // Celdas de datos (blancas con bordes) - ANTES de aplicar filas de Requisitos
                                    {
                                        repeatCell: {
                                            range: {
                                                sheetId: newSheetSheetId,
                                                startRowIndex: 6,
                                                endRowIndex: 30,
                                                startColumnIndex: 0,
                                                endColumnIndex: 15
                                            },
                                            cell: {
                                                userEnteredFormat: {
                                                    backgroundColor: {
                                                        red: 1,
                                                        green: 1,
                                                        blue: 1
                                                    },
                                                    textFormat: {
                                                        foregroundColor: {
                                                            red: 0,
                                                            green: 0,
                                                            blue: 0
                                                        }
                                                    },
                                                    borders: {
                                                        top: { style: 'SOLID', width: 1, color: { red: 0.8, green: 0.8, blue: 0.8 } },
                                                        bottom: { style: 'SOLID', width: 1, color: { red: 0.8, green: 0.8, blue: 0.8 } },
                                                        left: { style: 'SOLID', width: 1, color: { red: 0.8, green: 0.8, blue: 0.8 } },
                                                        right: { style: 'SOLID', width: 1, color: { red: 0.8, green: 0.8, blue: 0.8 } }
                                                    }
                                                }
                                            },
                                            fields: 'userEnteredFormat(backgroundColor,textFormat,borders)'
                                        }
                                    },
                                    // IMPORTANTE: Aplicar formato de Requisitos AL FINAL (para que no sea sobreescrito)
                                    // Aplicar a AMBAS filas: la del t√≠tulo Y la siguiente (headers de columnas)
                                    ...requisitosRows.map(reqRow => [
                                        // FILA DEL T√çTULO (ej: "Requisitos Funcionales")
                                        // Secci√≥n Nombre (azul) - columnas 0-2
                                        {
                                            repeatCell: {
                                                range: {
                                                    sheetId: newSheetSheetId,
                                                    startRowIndex: reqRow.row,
                                                    endRowIndex: reqRow.row + 1,
                                                    startColumnIndex: 0,
                                                    endColumnIndex: 2
                                                },
                                                cell: {
                                                    userEnteredFormat: {
                                                        backgroundColor: {
                                                            red: 0.26,
                                                            green: 0.52,
                                                            blue: 0.96
                                                        },
                                                        textFormat: {
                                                            bold: true,
                                                            foregroundColor: {
                                                                red: 1,
                                                                green: 1,
                                                                blue: 1
                                                            }
                                                        }
                                                    }
                                                },
                                                fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                            }
                                        },
                                        // AI section (verde) - columnas 2-7
                                        {
                                            repeatCell: {
                                                range: {
                                                    sheetId: newSheetSheetId,
                                                    startRowIndex: reqRow.row,
                                                    endRowIndex: reqRow.row + 1,
                                                    startColumnIndex: 2,
                                                    endColumnIndex: 7
                                                },
                                                cell: {
                                                    userEnteredFormat: {
                                                        backgroundColor: {
                                                            red: 0.34,
                                                            green: 0.73,
                                                            blue: 0.34
                                                        },
                                                        textFormat: {
                                                            bold: true,
                                                            foregroundColor: {
                                                                red: 1,
                                                                green: 1,
                                                                blue: 1
                                                            }
                                                        }
                                                    }
                                                },
                                                fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                            }
                                        },
                                        // HUMANOS section (rojo) - columnas 7-12
                                        {
                                            repeatCell: {
                                                range: {
                                                    sheetId: newSheetSheetId,
                                                    startRowIndex: reqRow.row,
                                                    endRowIndex: reqRow.row + 1,
                                                    startColumnIndex: 7,
                                                    endColumnIndex: 12
                                                },
                                                cell: {
                                                    userEnteredFormat: {
                                                        backgroundColor: {
                                                            red: 0.98,
                                                            green: 0.4,
                                                            blue: 0.4
                                                        },
                                                        textFormat: {
                                                            bold: true,
                                                            foregroundColor: {
                                                                red: 1,
                                                                green: 1,
                                                                blue: 1
                                                            }
                                                        }
                                                    }
                                                },
                                                fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                            }
                                        },
                                        // MARKUP section (amarillo) - solo columna 13 (N)
                                        {
                                            repeatCell: {
                                                range: {
                                                    sheetId: newSheetSheetId,
                                                    startRowIndex: reqRow.row,
                                                    endRowIndex: reqRow.row + 1,
                                                    startColumnIndex: 13,
                                                    endColumnIndex: 14
                                                },
                                                cell: {
                                                    userEnteredFormat: {
                                                        backgroundColor: {
                                                            red: 1,
                                                            green: 0.95,
                                                            blue: 0.4
                                                        },
                                                        textFormat: {
                                                            bold: true,
                                                            foregroundColor: {
                                                                red: 0,
                                                                green: 0,
                                                                blue: 0
                                                            }
                                                        }
                                                    }
                                                },
                                                fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                            }
                                        },
                                        // Resto (azul) - columnas 14+
                                        {
                                            repeatCell: {
                                                range: {
                                                    sheetId: newSheetSheetId,
                                                    startRowIndex: reqRow.row,
                                                    endRowIndex: reqRow.row + 1,
                                                    startColumnIndex: 14,
                                                    endColumnIndex: 26
                                                },
                                                cell: {
                                                    userEnteredFormat: {
                                                        backgroundColor: {
                                                            red: 0.26,
                                                            green: 0.52,
                                                            blue: 0.96
                                                        },
                                                        textFormat: {
                                                            bold: true,
                                                            foregroundColor: {
                                                                red: 1,
                                                                green: 1,
                                                                blue: 1
                                                            }
                                                        }
                                                    }
                                                },
                                                fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                            }
                                        },

                                        // FILA SIGUIENTE (ej: "# ITEM DESCRIPCION...")
                                        // Secci√≥n Nombre (azul) - columnas 0-2
                                        // Secci√≥n Nombre (azul) - columnas 0-2
                                        {
                                            repeatCell: {
                                                range: {
                                                    sheetId: newSheetSheetId,
                                                    startRowIndex: reqRow.row + 1,
                                                    endRowIndex: reqRow.row + 2,
                                                    startColumnIndex: 0,
                                                    endColumnIndex: 2
                                                },
                                                cell: {
                                                    userEnteredFormat: {
                                                        backgroundColor: {
                                                            red: 0.26,
                                                            green: 0.52,
                                                            blue: 0.96
                                                        },
                                                        textFormat: {
                                                            bold: true,
                                                            foregroundColor: {
                                                                red: 1,
                                                                green: 1,
                                                                blue: 1
                                                            }
                                                        }
                                                    }
                                                },
                                                fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                            }
                                        },
                                        // AI section (verde) - columnas 2-7
                                        {
                                            repeatCell: {
                                                range: {
                                                    sheetId: newSheetSheetId,
                                                    startRowIndex: reqRow.row + 1,
                                                    endRowIndex: reqRow.row + 2,
                                                    startColumnIndex: 2,
                                                    endColumnIndex: 7
                                                },
                                                cell: {
                                                    userEnteredFormat: {
                                                        backgroundColor: {
                                                            red: 0.34,
                                                            green: 0.73,
                                                            blue: 0.34
                                                        },
                                                        textFormat: {
                                                            bold: true,
                                                            foregroundColor: {
                                                                red: 1,
                                                                green: 1,
                                                                blue: 1
                                                            }
                                                        }
                                                    }
                                                },
                                                fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                            }
                                        },
                                        // HUMANOS section (rojo) - columnas 7-12
                                        {
                                            repeatCell: {
                                                range: {
                                                    sheetId: newSheetSheetId,
                                                    startRowIndex: reqRow.row + 1,
                                                    endRowIndex: reqRow.row + 2,
                                                    startColumnIndex: 7,
                                                    endColumnIndex: 12
                                                },
                                                cell: {
                                                    userEnteredFormat: {
                                                        backgroundColor: {
                                                            red: 0.98,
                                                            green: 0.4,
                                                            blue: 0.4
                                                        },
                                                        textFormat: {
                                                            bold: true,
                                                            foregroundColor: {
                                                                red: 1,
                                                                green: 1,
                                                                blue: 1
                                                            }
                                                        }
                                                    }
                                                },
                                                fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                            }
                                        },
                                        // MARKUP section (amarillo) - solo columna 12
                                        {
                                            repeatCell: {
                                                range: {
                                                    sheetId: newSheetSheetId,
                                                    startRowIndex: reqRow.row + 1,
                                                    endRowIndex: reqRow.row + 2,
                                                    startColumnIndex: 12,
                                                    endColumnIndex: 13
                                                },
                                                cell: {
                                                    userEnteredFormat: {
                                                        backgroundColor: {
                                                            red: 1,
                                                            green: 0.95,
                                                            blue: 0.4
                                                        },
                                                        textFormat: {
                                                            bold: true,
                                                            foregroundColor: {
                                                                red: 0,
                                                                green: 0,
                                                                blue: 0
                                                            }
                                                        }
                                                    }
                                                },
                                                fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                            }
                                        },
                                        // Resto (azul) - columnas 13+
                                        {
                                            repeatCell: {
                                                range: {
                                                    sheetId: newSheetSheetId,
                                                    startRowIndex: reqRow.row + 1,
                                                    endRowIndex: reqRow.row + 2,
                                                    startColumnIndex: 13,
                                                    endColumnIndex: 26
                                                },
                                                cell: {
                                                    userEnteredFormat: {
                                                        backgroundColor: {
                                                            red: 0.26,
                                                            green: 0.52,
                                                            blue: 0.96
                                                        },
                                                        textFormat: {
                                                            bold: true,
                                                            foregroundColor: {
                                                                red: 1,
                                                                green: 1,
                                                                blue: 1
                                                            }
                                                        }
                                                    }
                                                },
                                                fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                            }
                                        }
                                    ]).flat()
                                ]
                            }
                        });
                        log('‚úÖ Formato completo aplicado correctamente');
                    } catch (formatError) {
                        log(`‚ö†Ô∏è Error aplicando formato: ${formatError.message}`);
                        log('üìù Aplicando formato b√°sico como fallback...');

                        // Fallback b√°sico
                        await gapi.client.sheets.spreadsheets.batchUpdate({
                            spreadsheetId: newSheetId,
                            resource: {
                                requests: [
                                    {
                                        repeatCell: {
                                            range: {
                                                sheetId: createResponse.result.sheets[0].properties.sheetId,
                                                startRowIndex: 0,
                                                endRowIndex: 10,
                                                startColumnIndex: 0,
                                                endColumnIndex: 15
                                            },
                                            cell: {
                                                userEnteredFormat: {
                                                    backgroundColor: {
                                                        red: 0.26,
                                                        green: 0.52,
                                                        blue: 0.96
                                                    },
                                                    textFormat: {
                                                        bold: true,
                                                        foregroundColor: {
                                                            red: 1,
                                                            green: 1,
                                                            blue: 1
                                                        }
                                                    }
                                                }
                                            },
                                            fields: 'userEnteredFormat(backgroundColor,textFormat)'
                                        }
                                    }
                                ]
                            }
                        });
                        log('‚úÖ Formato b√°sico aplicado');
                    }

                } else {
                    log('‚ö†Ô∏è No se encontraron datos en el template, creando estructura b√°sica...');
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: newSheetId,
                        range: 'A1:C3',
                        valueInputOption: 'RAW',
                        resource: {
                            values: [
                                ['PRESUPUESTO WAZA', '', ''],
                                ['Proyecto:', '[NOMBRE_PROYECTO]', ''],
                                ['Cliente:', '[NOMBRE_CLIENTE]', '']
                            ]
                        }
                    });
                }

                const newSheetUrl = `https://docs.google.com/spreadsheets/d/${newSheetId}`;
                log(`üîó URL: ${newSheetUrl}`);

                // Abrir en nueva ventana
                window.open(newSheetUrl, '_blank');

            } catch (error) {
                log(`‚ùå Error general en Sheets API: ${error.message || error}`);
                log(`üìù Detalles completos: ${JSON.stringify(error)}`);
                console.error('Sheets error:', error);
            }
        }

        // Inicializar cuando cargue la p√°gina
        window.onload = function() {
            log('üöÄ P√°gina cargada');
            updateStatus('üîÑ Cargando APIs...');
            initGAPI();
        };
    </script>
</body>
</html>
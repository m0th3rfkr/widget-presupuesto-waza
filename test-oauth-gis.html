<!DOCTYPE html>
<html>
<head>
    <title>ğŸš€ Test OAuth Google - Nueva API (GIS)</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <h1>ğŸš€ Test OAuth Google - Nueva API (GIS)</h1>

    <div id="status">ğŸ”„ Inicializando...</div>

    <br><br>
    <div id="buttonDiv"></div>
    <button id="signout-btn" onclick="signOut()" disabled>ğŸšª Cerrar SesiÃ³n</button>

    <br><br>
    <button id="test-drive" onclick="testDrive()" disabled>ğŸ“ Test Drive API</button>
    <button id="test-sheets" onclick="testSheets()" disabled>ğŸ“Š Test Sheets API</button>

    <div id="logs" style="margin-top: 20px; background: #f0f0f0; padding: 10px; font-family: monospace; max-height: 400px; overflow-y: auto;"></div>

    <script>
        // ConfiguraciÃ³n
        const CLIENT_ID = '64644619494-tous9hjfmhdpmcfnj18b067tnj3ve9f9.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyA5WkzYdrn2v24fgB1rln5qnbhs7iivFNs';
        const SCOPES = 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/spreadsheets';

        let tokenClient;
        let accessToken = null;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
            log(`STATUS: ${message}`);
        }

        function updateButtons(isSignedIn) {
            document.getElementById('signout-btn').disabled = !isSignedIn;
            document.getElementById('test-drive').disabled = !isSignedIn;
            document.getElementById('test-sheets').disabled = !isSignedIn;
        }

        // Inicializar Google Identity Services
        function initializeGIS() {
            updateStatus('ğŸ”„ Inicializando Google Identity Services...');
            log('ğŸš€ Configurando nueva Google Identity Services API');

            log(`ğŸ”‘ Client ID: ${CLIENT_ID}`);
            log(`ğŸ—ï¸ API Key: ${API_KEY.substring(0, 20)}...`);
            log(`ğŸ” Scopes: ${SCOPES}`);

            // Inicializar cliente de tokens
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    log('âœ… Token recibido exitosamente');
                    log(`ğŸ« Access token: ${tokenResponse.access_token.substring(0, 20)}...`);

                    accessToken = tokenResponse.access_token;
                    gapi.client.setToken({ access_token: accessToken });

                    updateStatus('âœ… Autenticado correctamente con Google Identity Services');
                    updateButtons(true);

                    log('ğŸ‰ Proceso de autenticaciÃ³n completado');
                },
                error_callback: (error) => {
                    log(`âŒ Error en token: ${JSON.stringify(error)}`);
                    updateStatus('âŒ Error en autenticaciÃ³n');
                    updateButtons(false);
                }
            });

            // Crear botÃ³n de login
            google.accounts.id.initialize({
                client_id: CLIENT_ID,
                callback: handleCredentialResponse
            });

            // BotÃ³n personalizado para OAuth
            const buttonDiv = document.getElementById('buttonDiv');
            buttonDiv.innerHTML = '<button onclick="requestAccessToken()" style="padding: 10px 20px; font-size: 16px;">ğŸ”‘ Autorizar Google APIs</button>';

            updateStatus('âœ… Google Identity Services inicializado - Click para autorizar');
            log('âœ… GIS inicializado correctamente');
        }

        // Solicitar token de acceso
        function requestAccessToken() {
            log('ğŸ”‘ Solicitando token de acceso...');
            updateStatus('ğŸ”„ Solicitando autorizaciÃ³n...');

            // Verificar si ya tenemos token vÃ¡lido
            if (accessToken) {
                log('âš ï¸ Ya existe un token, revocando primero...');
                google.accounts.oauth2.revoke(accessToken, () => {
                    log('ğŸ—‘ï¸ Token anterior revocado');
                });
            }

            tokenClient.requestAccessToken({
                prompt: 'consent'
            });
        }

        // Manejar respuesta de credenciales (para ID token)
        function handleCredentialResponse(response) {
            log('ğŸ†” ID Token recibido');
            // Este es solo para identificaciÃ³n, no para APIs
        }

        // Cerrar sesiÃ³n
        function signOut() {
            log('ğŸšª Cerrando sesiÃ³n...');

            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken, () => {
                    log('âœ… Token revocado');
                    accessToken = null;
                    gapi.client.setToken(null);
                    updateStatus('âœ… SesiÃ³n cerrada');
                    updateButtons(false);
                });
            }
        }

        // Inicializar Google API Client
        function initGAPI() {
            log('ğŸ“š Inicializando Google API Client...');

            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [
                        'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                        'https://sheets.googleapis.com/$discovery/rest?version=v4'
                    ]
                });

                log('âœ… Google API Client inicializado');
                initializeGIS(); // Inicializar GIS despuÃ©s de GAPI
            });
        }

        // Test Drive API
        async function testDrive() {
            log('ğŸ“ Probando Drive API...');

            try {
                const response = await gapi.client.drive.files.list({
                    pageSize: 5,
                    fields: 'files(id, name, mimeType)'
                });

                const files = response.result.files;
                log(`âœ… Drive API OK - Encontrados ${files.length} archivos:`);

                files.forEach(file => {
                    log(`  ğŸ“„ ${file.name} (${file.id})`);
                });

            } catch (error) {
                log(`âŒ Error en Drive API: ${error.message}`);
                console.error('Drive error:', error);
            }
        }

        // Test Sheets API
        async function testSheets() {
            log('ğŸ“Š Probando Sheets API...');

            try {
                // Template ID del proyecto (actualizado - copia propia)
                const templateId = '1wR49oqHn3NdKj9pFzMdM2fpFpcYx7CxIZhLUHolWcA4';

                log(`ğŸ” Intentando acceder al template: ${templateId}`);

                // Primero probar acceso directo
                try {
                    const response = await gapi.client.sheets.spreadsheets.get({
                        spreadsheetId: templateId
                    });

                    log(`âœ… Sheets API OK - Template encontrado:`);
                    log(`  ğŸ“Š TÃ­tulo: ${response.result.properties.title}`);
                    log(`  ğŸ“„ Sheets: ${response.result.sheets.length}`);

                    response.result.sheets.forEach(sheet => {
                        log(`    - ${sheet.properties.title}`);
                    });

                } catch (sheetError) {
                    log(`âš ï¸ No se puede acceder al template directamente: ${sheetError.message}`);
                    log(`ğŸ”„ Intentando crear sheet nuevo desde cero...`);

                    // Crear un nuevo spreadsheet en lugar de copiar
                    const createResponse = await gapi.client.sheets.spreadsheets.create({
                        resource: {
                            properties: {
                                title: `Presupuesto Test - ${new Date().toLocaleString()}`
                            },
                            sheets: [{
                                properties: {
                                    title: 'Presupuesto',
                                    gridProperties: {
                                        rowCount: 100,
                                        columnCount: 15
                                    }
                                }
                            }]
                        }
                    });

                    const newSheetId = createResponse.result.spreadsheetId;
                    log(`âœ… Nuevo sheet creado: ${newSheetId}`);

                    // Agregar datos de prueba
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: newSheetId,
                        range: 'A1:C3',
                        valueInputOption: 'RAW',
                        resource: {
                            values: [
                                ['Proyecto', 'Cliente', 'Fecha'],
                                ['Proyecto Test OAuth', 'Cliente Test', new Date().toLocaleDateString()],
                                ['Estado:', 'âœ… OAuth funcionando!', 'ğŸš€ GIS implementado']
                            ]
                        }
                    });

                    log(`âœ… Datos de prueba agregados`);

                    const newSheetUrl = `https://docs.google.com/spreadsheets/d/${newSheetId}`;
                    log(`ğŸ”— URL: ${newSheetUrl}`);

                    // Abrir en nueva ventana
                    window.open(newSheetUrl, '_blank');
                    return;
                }

                // Si llegamos aquÃ­, el template es accesible, intentar copia
                log('ğŸ”„ Template accesible, creando copia...');

                const copyResponse = await gapi.client.drive.files.copy({
                    fileId: templateId,
                    resource: {
                        name: `Test Copy - ${new Date().toLocaleString()}`
                    }
                });

                const newSheetId = copyResponse.result.id;
                log(`âœ… Copia creada exitosamente: ${newSheetId}`);

                const newSheetUrl = `https://docs.google.com/spreadsheets/d/${newSheetId}`;
                log(`ğŸ”— URL: ${newSheetUrl}`);

                // Abrir en nueva ventana
                window.open(newSheetUrl, '_blank');

            } catch (error) {
                log(`âŒ Error general en Sheets API: ${error.message || error}`);
                log(`ğŸ“ Detalles completos: ${JSON.stringify(error)}`);
                console.error('Sheets error:', error);
            }
        }

        // Inicializar cuando cargue la pÃ¡gina
        window.onload = function() {
            log('ğŸš€ PÃ¡gina cargada');
            updateStatus('ğŸ”„ Cargando APIs...');
            initGAPI();
        };
    </script>
</body>
</html>